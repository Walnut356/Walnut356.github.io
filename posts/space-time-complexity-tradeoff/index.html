<!doctype html><html dir=auto lang=en><head><meta charset=utf-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content="index, follow" name=robots><title>The space time complexity tradeoff</title><meta name=keywords><meta name=description><meta content=Walnut356 name=author><link href=https://walnut356.github.io/posts/space-time-complexity-tradeoff/ rel=canonical><link href=/styles.css rel=stylesheet><link href=/override.css rel=stylesheet><link href=/syntax-theme.css rel=stylesheet><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap" rel=stylesheet><link crossorigin href=/CascadiaCode-Regular.woff2 rel=font><link href=/favicon.png rel=icon type=image/x-icon><link href=https://walnut356.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script src="https://www.googletagmanager.com/gtag/js?id=G-PKLX5VEB4H" async></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PKLX5VEB4H');</script><body class=dark id=top><script>if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }</script><header class=header><nav class=nav><div class=logo><a title="Cracking The Shell (Alt + H)" accesskey=h href=https://walnut356.github.io> Cracking The Shell </a><div class=logo-switches><button title="(Alt + T)" accesskey=t id=theme-toggle><svg viewbox="0 0 24 24" fill=none height=18 id=moon stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> <svg viewbox="0 0 24 24" fill=none height=18 id=sun stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></button><ul class=lang-switch><li></ul></div></div><ul id=menu><li><a href=https://walnut356.github.io/archive title=Archive> <span>Archive</span> </a><li><a href=https://walnut356.github.io/search title=Search> <span>Search</span> </a><li><a href=https://walnut356.github.io/tags title=Tags> <span>Tags</span> </a></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://walnut356.github.io>Home</a> »  <a href=https://walnut356.github.io/posts/>Posts</a> »  <a href=https://walnut356.github.io/posts/space-time-complexity-tradeoff/>The space time complexity tradeoff</a></div><h1 class=post-title>The space time complexity tradeoff</h1><div class=post-meta><span title="2024-03-09 00:00:00 +0000">2024-03-09</span> · 10 min · 1998 words</div></header><div class=toc><details><summary title="(Alt + C)" accesskey=c><span class=details>Table of Contents</span></summary> <div class=inner><ul><li><a aria-label=Representation href=#representation>Representation</a><li><a aria-label="Saving time" href=#saving-time>Saving time</a><li><a aria-label="Saving Space" href=#saving-space>Saving Space</a><li><a aria-label="But at what cost?" href=#but-at-what-cost>But at what cost?</a></ul></div></details></div><div class=post-content><p>I encountered a neat example recently while solving <a href=https://adventofcode.com/2015/day/6 rel=noopener target=_blank>Advent of Code 2015, day 6</a>. The problem can be boiled down to "There is a 2D array of values. Given a range and instruction, apply the instruction to all values in that range. How many values are 'on' at the end?". There are only 2 possible states for each value: on and off, and only 3 possible instructions: on, off, and toggle. I won't focus too much on parsing the input or the structure of the algorithm here, I just want to investigate the hot loop which applies the instruction to each value.</p><span id=continue-reading></span><p>Code is compiled using <code>-Ctarget-cpu=native</code> for a Ryzen 1600x running Windows.<h2 id=representation>Representation<a aria-hidden=true class=anchor hidden href=#representation>#</a></h2><p>Whenever I see a max of 2 states, my brain jumps straight to bit manipulation - why store in 8 bits what can be stored in 1 bit? The types of low-power, memory constrained platforms and programs I've investigated have given me lots of exposure bit fields. While that's what I'm comfortable with, it's often much closer to the "space" end of the space-time tradeoff. For something on the speedier side, we can represent the values as 8-bit bools.<p>While I could use an array of arrays, there's no real need to when working with uniform dimensions (1000x1000 in this case). The bool array can be represented as <code>[bool; 1000 * 1000]</code> and the bit array as <code>[u8; 125 * 1000]</code>, saving 875kb. While that sounds like an insignificant amount, it's worth noting that <a href=https://www.techpowerup.com/cpu-specs/ryzen-5-1600x.c1894 rel=noopener target=_blank>my CPU</a> has an L1 data cache size of 32kb and an L2 cache size of 512kb. The bitwise implementation could reside entirely in the L2 cache, whereas the bool array necessitates pulling some data from L3. L3 access can be <a href=https://www.7-cpu.com/cpu/Zen.html rel=noopener target=_blank>somewhat expensive</a>, so it could make a difference.<h2 id=saving-time>Saving time<a aria-hidden=true class=anchor hidden href=#saving-time>#</a></h2><p>As a quick spoiler, the correct answer for my input data is <code>377891</code>. This blog post isn't really about solving the problem (nor the most optimal solution), but it's important to ensure that no matter what we change we're still getting the correct answer. Wrong code is still wrong no matter how fast it is.<p>That aside, after parsing the line into the instruction and a Coordinate struct representing the "top left" and "bottom right" corners of the affected area, we can construct a simple loop that traverses the range<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">y</span><span class="z-keyword z-operator z-range z-rust">..=</span><span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">y</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">x</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span><span class="z-keyword z-operator z-range z-rust">..=</span><span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-macro z-rust">todo!</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>For bools, the loop contents are very simple, just translate the 2D coordinate into a 1D array index. Also note that the nesting-order of the loop matters. Row-wise access is typically more performant due to locality. Simply reversing the order of the loop slows down execution time by about 30%.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">y</span><span class="z-keyword z-operator z-range z-rust">..=</span><span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">y</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">x</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span><span class="z-keyword z-operator z-range z-rust">..=</span><span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-local z-rust">array</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1000</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-variable z-local z-rust">x</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-language z-rust">true</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> off:
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> array[y * 1000 + x] = false;
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> toggle:
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> array[y * 1000 + x] ^= true;
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>To collect the values at the end, we can use an iter-fold:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-variable z-local z-rust">array</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">iter</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">fold</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">|</span><span class="z-variable z-local z-rust">acc</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-variable z-local z-rust">x</span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-variable z-local z-rust">acc</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-variable z-local z-rust">x</span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-primitive z-rust">usize</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></code></pre><p>And hey, we get the correct answer in only ~18ms.<h2 id=saving-space>Saving Space<a aria-hidden=true class=anchor hidden href=#saving-space>#</a></h2><p>But what if we want to fiddle with bits? Well I've got 2 options in mind, and one is a bit spicy. The first is the simple bitwise operations we're used to, the only tricky part being that we need to index into both the array and the individual u8s at the same time. 2D -> 1D array access is <code>y * width + x</code>. but since our array width is effectively 8x less, we need to divide both sides by 8. To get the offset into the u8, we need the remainder of <code>x / 8</code>. We can then bitshift by that offset and set/clear/complement to apply the operation:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> fun fact, the compiler isn't smart enough to remove the
</span></span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> bounds check on the array access, even with the assertions:
</span></span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> assert!(start.y <= 999 && end.y <= 999);
</span></span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> assert!(start.x <= 999 && end.x <= 999);
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">y</span><span class="z-keyword z-operator z-range z-rust">..=</span><span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">y</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">x</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span><span class="z-keyword z-operator z-range z-rust">..=</span><span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">idx</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">125</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">x</span> <span class="z-keyword z-operator z-arithmetic z-rust">/</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">8</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">offset</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-local z-rust">x</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">8</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-local z-rust">bit_array</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">idx</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-assignment z-rust">|=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span> <span class="z-keyword z-operator z-bitwise z-rust"><<</span> <span class="z-variable z-local z-rust">offset</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> off:
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> bit_array[idx] &= 0xFF ^ (1 << offset);
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> toggle:
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> bit_array[idx] ^= 1 << offset;
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>Collecting the values requires a slight modification of the iter-fold:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-variable z-local z-rust">bit_array</span>
</span><span class="z-source z-rust">    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">iter</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span><span class="z-source z-rust">    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">fold</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">|</span><span class="z-variable z-local z-rust">acc</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-variable z-local z-rust">x</span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-variable z-local z-rust">acc</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-variable z-local z-rust">x</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">count_ones</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-primitive z-rust">usize</span><span class="z-punctuation z-section z-group z-end z-rust">)</span>
</span></code></pre><p>This runs a bit slower at ~28ms.<p>So how about a little spice? This was my original solution:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">ptr</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-local z-rust">bit_array</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">as_mut_ptr</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">y</span><span class="z-keyword z-operator z-range z-rust">..=</span><span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">y</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">x</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span><span class="z-keyword z-operator z-range z-rust">..=</span><span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">bit_idx</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1000</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-variable z-local z-rust">x</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> wew
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-support z-macro z-rust">asm!</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>bts [{ptr}], {bit_idx}<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> off:
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> "btr [{ptr}], {bit_idx}",
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> toggle:
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> "btc [{ptr}], {bit_idx}",
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-variable z-local z-rust">bit_idx</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-rust">in</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">reg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-variable z-local z-rust">bit_idx</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-variable z-local z-rust">ptr</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-rust">in</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">reg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-variable z-local z-rust">ptr</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-section z-group z-end z-rust">)</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>I had just finished reading The Art of 64-bit Assembly, and the BT* instructions were fresh on my mind. For those that don't read ISAs in your free time, BTS, BTR, and BTC are <em>very</em> cool instructions. The mnemonics are short for "Bit Test and &LTSet / Reset / Complement>". You feed the instruction a memory address and a <em>bit</em> offset, and it sets it, clears it, or inverts it. It also sets the carry flag so you know what the bit was before you operated on it, and you can optionally make the instruction atomic.<p>It took me a few minutes to come up with - and convince myself of the correctness of - the indexing formula for the bitwise version. This version is the same level of cognitive complexity as the array of booleans, but with the space saving of the bitwise operations. Relative to other assembly instructions, I especially like how human-readable it is. I've spent a decent amount of time staring at PowerPC assembly, and the somewhat equivalent <a href="https://www.ibm.com/docs/ru/aix/7.2?topic=is-rlwimi-rlimi-rotate-left-word-immediate-then-mask-insert-instruction" rel=noopener target=_blank>RLWIMI</a> and RLWINM instructions require <a href="https://mariokartwii.com/showthread.php?tid=1262" rel=noopener target=_blank>several paragraphs</a> to explain, and are <em>still</em> kinda incomprehensible at a glance. RLWIMI has some cool differences, such as being able to operate on a range of bits all at once, but in most cases I see it used to modify a single bit.<p>All that aside, we can once again run it and see that we get the correct result, and a runtime of ... 47ms? Almost twice as slow as the bitwise version? That can't be right. Lets pull the work out of the loops into their own functions and check the disassembly to see what's actually going on. Running <code>cargo-show-asm</code> on the bitwise function reveals:<pre class="language-asm z-code" data-lang=asm><code class=language-asm data-lang=asm><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly">a</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">c</span><span class="z-entity z-name z-function z-assembly">2</span><span class="z-entity z-name z-function z-assembly">0</span><span class="z-entity z-name z-function z-assembly">1</span><span class="z-entity z-name z-function z-assembly">5</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly">a</span><span class="z-entity z-name z-function z-assembly">y</span><span class="z-entity z-name z-function z-assembly">6</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">b</span><span class="z-entity z-name z-function z-assembly">i</span><span class="z-entity z-name z-function z-assembly">t</span><span class="z-entity z-name z-function z-assembly">_</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">n</span><span class="z-entity z-name z-function z-assembly">:</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> pub fn bit_on(bit_array: &mut [u8; 125 * 1000], x: usize, y: usize)
</span></span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">sub</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">40</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r9</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rcx</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> let idx = (y * 125) + (x / 8);
</span></span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">imul</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rcx</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r8</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">125</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rdx</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">shr</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">3</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">add</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rcx</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> bit_array[idx] |= 1 << offset;
</span></span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">cmp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">124999</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">ja</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">.</span><span class="z-entity z-name z-function z-assembly">L</span><span class="z-entity z-name z-function z-assembly">B</span><span class="z-entity z-name z-function z-assembly">B</span><span class="z-entity z-name z-function z-assembly">2</span><span class="z-entity z-name z-function z-assembly">2</span><span class="z-entity z-name z-function z-assembly">2</span><span class="z-entity z-name z-function z-assembly">_</span><span class="z-entity z-name z-function z-assembly">2</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">and</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">dl</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">7</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r8b</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">1</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">ecx</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">edx</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">shl</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r8b</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">cl</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">or</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-support z-function z-directive z-assembly">byte</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-support z-function z-directive z-assembly">ptr</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">r9</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span><span class="z-source z-assembly">]</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r8b</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">add</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">40</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">ret</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly">.</span><span class="z-entity z-name z-function z-assembly">L</span><span class="z-entity z-name z-function z-assembly">B</span><span class="z-entity z-name z-function z-assembly">B</span><span class="z-entity z-name z-function z-assembly">2</span><span class="z-entity z-name z-function z-assembly">2</span><span class="z-entity z-name z-function z-assembly">2</span><span class="z-entity z-name z-function z-assembly">_</span><span class="z-entity z-name z-function z-assembly">2</span><span class="z-entity z-name z-function z-assembly">:</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> bit_array[idx] |= 1 << offset;
</span></span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">lea</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r8</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rip</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">_</span><span class="z-entity z-name z-function z-assembly">_</span><span class="z-entity z-name z-function z-assembly">u</span><span class="z-entity z-name z-function z-assembly">n</span><span class="z-entity z-name z-function z-assembly">n</span><span class="z-entity z-name z-function z-assembly">a</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">e</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly">_</span><span class="z-entity z-name z-function z-assembly">3</span><span class="z-entity z-name z-function z-assembly">7</span><span class="z-entity z-name z-function z-assembly">3</span><span class="z-source z-assembly">]</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">edx</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">125000</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rcx</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">call</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">c</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">r</span><span class="z-entity z-name z-function z-assembly">e</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">p</span><span class="z-entity z-name z-function z-assembly">a</span><span class="z-entity z-name z-function z-assembly">n</span><span class="z-entity z-name z-function z-assembly">i</span><span class="z-entity z-name z-function z-assembly">c</span><span class="z-entity z-name z-function z-assembly">k</span><span class="z-entity z-name z-function z-assembly">i</span><span class="z-entity z-name z-function z-assembly">n</span><span class="z-entity z-name z-function z-assembly">g</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">p</span><span class="z-entity z-name z-function z-assembly">a</span><span class="z-entity z-name z-function z-assembly">n</span><span class="z-entity z-name z-function z-assembly">i</span><span class="z-entity z-name z-function z-assembly">c</span><span class="z-entity z-name z-function z-assembly">_</span><span class="z-entity z-name z-function z-assembly">b</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">u</span><span class="z-entity z-name z-function z-assembly">n</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly">s</span><span class="z-entity z-name z-function z-assembly">_</span><span class="z-entity z-name z-function z-assembly">c</span><span class="z-entity z-name z-function z-assembly">h</span><span class="z-entity z-name z-function z-assembly">e</span><span class="z-entity z-name z-function z-assembly">c</span><span class="z-entity z-name z-function z-assembly">k</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">ud2</span>
</span></code></pre><p>And for the inline assembly function:<pre class="language-asm z-code" data-lang=asm><code class=language-asm data-lang=asm><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly">a</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">c</span><span class="z-entity z-name z-function z-assembly">2</span><span class="z-entity z-name z-function z-assembly">0</span><span class="z-entity z-name z-function z-assembly">1</span><span class="z-entity z-name z-function z-assembly">5</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly">a</span><span class="z-entity z-name z-function z-assembly">y</span><span class="z-entity z-name z-function z-assembly">6</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">:</span><span class="z-entity z-name z-function z-assembly">a</span><span class="z-entity z-name z-function z-assembly">s</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">_</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">n</span><span class="z-entity z-name z-function z-assembly">:</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> pub fn asm_on(ptr: *mut u8, x: usize, y: usize) {
</span></span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">push</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> let bit_idx = y * 1000 + x;
</span></span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">imul</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r8</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">1000</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">add</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rdx</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> asm!(
</span></span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">#</span><span class="z-entity z-name z-function z-assembly">A</span><span class="z-entity z-name z-function z-assembly">P</span><span class="z-entity z-name z-function z-assembly">P</span>
</span><span class="z-source z-assembly">
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">bts</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-support z-function z-directive z-assembly">qword</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-support z-function z-directive z-assembly">ptr</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rcx</span><span class="z-source z-assembly">]</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span>
</span><span class="z-source z-assembly">
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">#</span><span class="z-entity z-name z-function z-assembly">N</span><span class="z-entity z-name z-function z-assembly">O</span><span class="z-entity z-name z-function z-assembly">_</span><span class="z-entity z-name z-function z-assembly">A</span><span class="z-entity z-name z-function z-assembly">P</span><span class="z-entity z-name z-function z-assembly">P</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">pop</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rax</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-keyword z-control z-assembly">ret</span>
</span></code></pre><p>Ignoring the function setup/teardown/panic, the inline assembly is significantly shorter - just 3 instructions, no branches vs the 11 and never-taken branch of the bitwise function. So why's it so much slower?<p>I mentioned in the bool function that the nesting order of the loops was important for cache locality. What I didn't mention was that the equation changes when you're operating repeatedly on a single value, which the ASM and bitwise functions both frequently do. Modern CPUs are pipelined, meaning they're simultaneously executing several instructions at a time. A caveat of this is that any instruction that requires data from an instruction <em>currently in the pipeline</em> must wait until that instruction is completely finished before it can begin. This is called <strong>instruction latency</strong>. Stalling the pipeline like this can be disastrous for performance.<p>When we reverse the loop ordering, the bitwise function runs in ~26ms, essentially no change at all. On the other hand, the ASM function now executes in <strong>30ms</strong>, a massive speedup. This is likely due to the tighter overall loop - the previous value would have had time to clear the pipeline in the bitwise function due to the extra instructions and loop handling, but not in the ASM function. It's not too surprising that both methods are slower than the boolean version though; we have to do a bit of extra work with the values involved, and the reduced cache locality likely has a slight negative impact.<p>There's still a slight performance disparity between the two bitwise versions though and I'm honestly not 100% what it is. I investigated the <a href=https://www.uops.info/table.html rel=noopener target=_blank>instruction tables</a> for my CPU, the AMD64 Architecture Programmer's Manual, and various forums. I'm not an expert at reading these sorts of sources by any means, but while the BT* instructions are definitely on the slower end, the numbers don't seem unreasonably bad. The general consensus seems to be that they're just slower than you'd expect when operating on memory.<h2 id=but-at-what-cost>But at what cost?<a aria-hidden=true class=anchor hidden href=#but-at-what-cost>#</a></h2><p>For the final version, we can throw readability in the garbage. Neither the bitwise nor the ASM version are really the most optimal way to operate on this sort of dataset. We're operating on contiguous ranges, and because those ranges are usually pretty large, it makes more sense to do bulk operations rather than modify individual bits at a time. Doing so means we can maintain the cache locality of the bool version, the space savings of the bitwise version, and reduce the number of individual calls to memory greatly. To accomplish this, we can use u64's as a sort of "poor man's SIMD vector". Due to bad divisibility, we'll have to manage the fact that our "rows" won't end on even boundaries - for example, our first row of 1000 bits will end on the 39th bit of u64 #15. Luckily, 1,000,000 <em>is</em> divisible by 64, so we don't have to allocate any extra pad bytes. As an aside, an easier-to-reason-about method might be to have 16 rows of 1000, the extra space is simply ignored and doesn't affect the final total.<p>I'll admit, this one took me several hours of debugging and a night's sleep to get working properly. I ended up needing to write several of my own test cases, wrestle with the language, and correct a few of my own assumptions. Did you know that overflow on left shift (e.g. <code>u8::MAX << 8</code>) is undefined behavior C and is disallowed in Rust? I didn't, and apparently <a href=https://users.rust-lang.org/t/intentionally-overflow-on-shift/11859 rel=noopener target=_blank>I'm not the only one</a>.<p>In any case, I want to walk through this as it's a bit more involved than the previous examples.<p>Because we're operating on a range, we'll need start and end indexes. There isn't clean divisibility, so we need to delay the division as long as possible to avoid compounding truncation errors. Another difference is that we need to take the modulo of the full bit-index, not just the x value like before. This is because the rows don't always start and end on the same bit of their respective u64s (e.g. row 1 starts at bit 0, row 2 starts at bit 40).<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">y</span><span class="z-keyword z-operator z-range z-rust">..=</span><span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">y</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">start_idx</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1000</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">/</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">64</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">start_offset</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1000</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">64</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">end_idx</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1000</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">/</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">64</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">end_offset</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">y</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1000</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">x</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">64</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-operator z-range z-rust">...</span>
</span></span></code></pre><p>Next we set up the <code>start</code> bit mask by clearing the unnecessary bits via 2 bit shifts, and handle the case where the start and end index are identical. The second step isn't necessary if you structure things a bit differently, but this makes a bit more sense to my brain. Note that when handling the "end" index, we need to alter the bit shifts so that we clear off bits on the opposite side.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust">    <span class="z-keyword z-operator z-range z-rust">...</span>
</span><span class="z-source z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-local z-rust">start</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-primitive z-rust">u64</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-constant z-other z-rust">MAX</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">    <span class="z-variable z-local z-rust">start</span> <span class="z-keyword z-operator z-assignment z-rust"><<=</span> <span class="z-variable z-local z-rust">start_offset</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">    <span class="z-variable z-local z-rust">start</span> <span class="z-keyword z-operator z-assignment z-rust">>>=</span> <span class="z-variable z-local z-rust">start_offset</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> if we're setting 64 bits or less, we modify only the start value
</span></span><span class="z-source z-rust">    <span class="z-keyword z-control z-rust">if</span> <span class="z-variable z-local z-rust">start_idx</span> <span class="z-keyword z-operator z-comparison z-rust">==</span> <span class="z-variable z-local z-rust">end_idx</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> reverse of the above operation
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-local z-rust">start</span> <span class="z-keyword z-operator z-assignment z-rust">>>=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">63</span> <span class="z-keyword z-operator z-arithmetic z-rust">-</span> <span class="z-variable z-local z-rust">end_offset</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-local z-rust">start</span> <span class="z-keyword z-operator z-assignment z-rust"><<=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">63</span> <span class="z-keyword z-operator z-arithmetic z-rust">-</span> <span class="z-variable z-local z-rust">end_offset</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-local z-rust">bit_array</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">start_idx</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-assignment z-rust">|=</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">continue</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">    <span class="z-variable z-local z-rust">bit_array</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">start_idx</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-assignment z-rust">|=</span> <span class="z-variable z-local z-rust">start</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">    <span class="z-keyword z-operator z-range z-rust">...</span>
</span></code></pre><p>We then loop through the values between the start and end, replacing them with <code>u64::MAX</code>, 0, or <code>xor</code>ing them with <code>u64::MAX</code> as required.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust">    <span class="z-keyword z-operator z-range z-rust">...</span>
</span><span class="z-source z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> loop over x values
</span></span><span class="z-source z-rust">    <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">i</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-local z-rust">start_idx</span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-variable z-local z-rust">end_idx</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-local z-rust">bit_array</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">i</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-primitive z-rust">u64</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-constant z-other z-rust">MAX</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-source z-rust">    <span class="z-keyword z-operator z-range z-rust">...</span>
</span></code></pre><p>After that, we handle the end index and we're all done!<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust">    <span class="z-keyword z-operator z-range z-rust">...</span>
</span><span class="z-source z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-local z-rust">end</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-primitive z-rust">u64</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-constant z-other z-rust">MAX</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> clear off only the bits within our range
</span></span><span class="z-source z-rust">    <span class="z-variable z-local z-rust">end</span> <span class="z-keyword z-operator z-assignment z-rust">>>=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">63</span> <span class="z-keyword z-operator z-arithmetic z-rust">-</span> <span class="z-variable z-local z-rust">end_offset</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">    <span class="z-variable z-local z-rust">end</span> <span class="z-keyword z-operator z-assignment z-rust"><<=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">63</span> <span class="z-keyword z-operator z-arithmetic z-rust">-</span> <span class="z-variable z-local z-rust">end_offset</span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">    <span class="z-variable z-local z-rust">bit_array</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">end_idx</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-assignment z-rust">|=</span> <span class="z-variable z-local z-rust">end</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>Running this gives us the correct answer, in only 544.658µs - a speedup of ~30x over the boolean version using 1/8th the memory, and a ~45x speedup over the bitwise version. All it cost was several hours, a bit of hair pulling, and some extra comments in the source code.<p>At this point, I suspect that we're nearing the limit of how much faster we can make it. We could experiment with real SIMD registers and operate on even larger bit slices, but that's for some other time. If you want to see the full source code, it's available <a href=https://github.com/Walnut356/AdventofCode/blob/master/aoc2015/src/day6.rs rel=noopener target=_blank>here</a>.<p>I think this problem is a really neat demonstration of the tradeoffs between memory usage, CPU time, and the readability of your code. It also provides a nice reminder that sometimes readability can come from unlikely places - in this case, a simple assembly instruction has (arguably) less cognitive complexity than the equivalent high-level bitwise indexing. While we often see examples of what great code looks like, and how we can still make great code that's <em>performant</em>, I always find it a fun exercise to <a href="https://www.youtube.com/watch?v=4LiP39gJuqE" rel=noopener target=_blank>throw all that to the wind and write some very fast, very gross code</a>. One of my favorite experiences with programming has been learning how insanely fast computers really are, and just how far you can push the limited tool sets that programming languages provide.</div><footer class=post-footer><ul class=post-tags><li><a href=https://walnut356.github.io/tags/programming/>programming</a><li><a href=https://walnut356.github.io/tags/rust/>rust</a></ul><nav class=paginav><a class=prev href=https://walnut356.github.io/posts/protoss-cost-efficiency/> <span class=title>« Prev</span> <br> <span>Protoss has always had a cost efficiency problem</span> </a><a class=next href=https://walnut356.github.io/posts/simulating-starcraft-p1/> <span class=title>Next »</span> <br> <span>Simulating Starcraft Part 1 - Tracer Bullet</span> </a></nav></footer></article></main><footer class=footer><span>© 2025 <a href=https://walnut356.github.io>Walnut356</a></span><span> Powered by <a rel="noopener noreferrer" href=https://www.getzola.org/ target=_blank>Zola</a> & <a href=https://github.com/cydave/zola-theme-papermod rel=noopener target=_blank>PaperMod</a> </span></footer><a aria-label="go to top" title="Go to Top (Alt + G)" accesskey=g class=top-link href=#top id=top-link> <svg viewbox="0 0 12 6" fill=currentColor xmlns=http://www.w3.org/2000/svg><path d="M12 6H0l6-6z"/></svg> </a><script>let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });</script><script>var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };</script><script>document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })</script><script>document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';
        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                var content = codeblock.textContent;
                if(codeblock.firstChild.tagName == 'TABLE') {
                    content = Array(...codeblock.firstChild.getElementsByTagName('span')).map((span) => { return span.textContent; }).join('');
                }
                navigator.clipboard.writeText(content);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });</script>