<!doctype html><html dir=auto lang=en><head><meta charset=utf-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content="index, follow" name=robots><title>Bypassing the borrow checker - do ref -> ptr -> ref partial borrows cause UB?</title><meta name=keywords><meta name=description><meta content=Walnut356 name=author><link href=https://walnut356.github.io/posts/partial-borrow-pointer-ub/ rel=canonical><link href=/styles.css rel=stylesheet><link href=/override.css rel=stylesheet><link href=/syntax-theme.css rel=stylesheet><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap" rel=stylesheet><link crossorigin href=/CascadiaCode-Regular.woff2 rel=font><link href=/favicon.png rel=icon type=image/x-icon><link href=https://walnut356.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script src="https://www.googletagmanager.com/gtag/js?id=G-PKLX5VEB4H" async></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PKLX5VEB4H');</script><body class=dark id=top><script>if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }</script><header class=header><nav class=nav><div class=logo><a title="Cracking The Shell (Alt + H)" accesskey=h href=https://walnut356.github.io> Cracking The Shell </a><div class=logo-switches><button title="(Alt + T)" accesskey=t id=theme-toggle><svg viewbox="0 0 24 24" fill=none height=18 id=moon stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> <svg viewbox="0 0 24 24" fill=none height=18 id=sun stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></button><ul class=lang-switch><li></ul></div></div><ul id=menu><li><a href=https://walnut356.github.io/archive title=Archive> <span>Archive</span> </a><li><a href=https://walnut356.github.io/search title=Search> <span>Search</span> </a><li><a href=https://walnut356.github.io/tags title=Tags> <span>Tags</span> </a></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://walnut356.github.io>Home</a> »  <a href=https://walnut356.github.io/posts/>Posts</a> »  <a href=https://walnut356.github.io/posts/partial-borrow-pointer-ub/>Bypassing the borrow checker - do ref -> ptr -> ref partial borrows cause UB?</a></div><h1 class=post-title>Bypassing the borrow checker - do ref -> ptr -> ref partial borrows cause UB?</h1><div class=post-meta><span title="2024-08-09 00:00:00 +0000">2024-08-09</span> · 30 min · 5893 words</div></header><div class=toc><details><summary title="(Alt + C)" accesskey=c><span class=details>Table of Contents</span></summary> <div class=inner><ul><li><a aria-label="The partial borrow problem" href=#the-partial-borrow-problem>The partial borrow problem</a><li><a aria-label="But is there undefined behavior?" href=#but-is-there-undefined-behavior>But is there undefined behavior?</a> <ul><li><a aria-label="Rust's Rules" href=#rust-s-rules>Rust's Rules</a><li><a aria-label="LLVM's rules" href=#llvm-s-rules>LLVM's rules</a><li><a aria-label="LLVM IR" href=#llvm-ir>LLVM IR</a></ul><li><a aria-label=Speculation href=#speculation>Speculation</a></ul></div></details></div><div class=post-content><p>Partial borrows across function boundaries don't really work in Rust. Unfortunately, that's kind of a major issue. There are workarounds, some are outlined <a href=https://smallcultfollowing.com/babysteps/blog/2018/11/01/after-nll-interprocedural-conflicts/ rel=noopener target=_blank>here</a>, but all of them come with pretty major drawbacks.</p><span id=continue-reading></span><p>Inlining is a nightmare for obvious reasons. Factoring ruins your struct layout (which could matter a lot for performance reasons), and can make your code substantially less readable as related information is no longer packed together, or the internal relationships end up mangled.<p>Free (or associated) functions are just awful. They break encapsulation, they interact awkwardly with the surrounding code, and they're far easier to make mistakes with. If I call <code>self.lookup()</code>, I can look at the constraints of <code>self</code> and <code>lookup()</code> and know that the function is infallible. An associated function that just takes a generic reference to a hashmap <em>may</em> panic due to <code>.get().unwrap()</code> because someone wasn't paying attention and tossed any ol' hashmap in there. The whole point of methods is to prevent putting nonsense data into highly constrained functions, and it's frustrating having to work around such a glaring hole in Rust's (usually) clear and convenient semantics.<p>I don't have a ton of experience with view structs, but at the very least they're a bit of extra legwork and split the logic code between multiple different structs.<p>In the back of my mind has always sat the idea that I have an escape-hatch with raw pointers. This sort of "partial borrow" issue would be non-existent in C, and pointers are pointers, so there shouldn't be any real issue in Rust. I held back partially because I never came across an instance of partial borrows annoying enough that it justified the <em>other</em> annoyance of using <code>unsafe</code>, partially because the documentation around pointers makes it a little unclear if the way I wanted to do things is <em>instantly</em> UB or not, and partially because any time I ask questions about <code>unsafe</code> in public forums, people get very condescending and preachy. It makes it very hard to learn when the information is being obfuscated by "if you need unsafe for something like this, your code is structured wrong" and "If I had review rights, I would reject any code that looked like this". I want to go on a bit of a tangent and share my thoughts about this sort of mentality. If you aren't interested, feel free to <a href=#the-partial-borrow-problem>skip to the meat of the post</a>.<p>By nature, I'm a very methodical person. I like clearly defined rules, well justified reasons behind those rules, and a thorough enough understanding that I can apply my knowledge to any situation - including when to bend or break the rules. At least for me, that sort of understanding can only come from careful prodding and experimentation. Stringently following exactly what the "best practices" are just isn't good enough - memorization and following instructions aren't the same as learning. What if the limits I was told were inaccurate, poorly worded, or overly cautious? Even if I eventually settle into following best practices, I have to <em>know</em> they're "best", and that only comes with experience. That may sound like a lot of unnecessary work. In some ways I guess it is. But I've found that, even outside of programming, established convention ends up being the willfully-ignorant-"we've always done it this way" variety just as often as it's been genuine wisdom. It might take me longer to get my bearings when trying something new, but I've always felt I come out the other end ahead of those who stay unquestioningly within the box of common practice.<p>One of the first programming videos I ever watched was <a href="https://www.youtube.com/watch?v=j0_u26Vpb4w" rel=noopener target=_blank>about "Forbidden" C++ by javidx9</a>. It's also one of my favorite programming videos I've <em>ever</em> watched. If you're strapped for time, this video goes over things like global variables, void pointers, and memory leaks. The purpose is demystifying these "bad practices" by explaining exactly <em>why</em> something like a global variable is considered bad practice, and giving legitimate use-cases for them. Most importantly, he assures the viewer that it's <strong>okay to experiment</strong>. As he says in <a href="https://youtu.be/vVRCJ52g5m4?t=415" rel=noopener target=_blank>another excellent video</a><blockquote><p>Remember, the tools work for you, and you can't hurt them... break the rules. Use global variables all over the place. Use unsafe system calls. Don't check all your integers to make sure they're within range. This is stuff they will not advise you to do at school.<p>Well you know what? It doesn't matter! You're learning! You're not gonna cause any harm. You're not going to break your computer (mostly). The computer doesn't have feelings, you're not going to upset it, and your code isn't being reviewed by somebody on the internet. It doesn't matter! Do whatever you need to do to get the job done... Get yourself into a real mess - there's no greater mental challenge for a programmer than debugging stuff. And if you want a career as a programmer, you're going to be debugging a lot of stuff... if you can get yourself out of it, that journey will have presented so much new learning to you. And if you get really stuck, select all, delete, start again... The best way to learn is to make mistakes.</blockquote><p>This was far and away the most liberating thing I heard when I was brand new to programming, and parts of this quote echo in my mind nearly every time I open up my IDE. The world won't end if my program is a little grimy. Learning is more important than idealized perfection, especially on a personal project.<p>When first starting out, undefined behavior was this "boogeyman" that lurked behind seemingly innocuous code. It could jump out from anywhere, do anything, at any time. The more I've learned about compilers (and I'm no expert by any means), the more I dislike that view. Compilers are not magic, they don't turn your code into nonsense on a whim. Even the consequences of the UB are "predictable" in the sense that there's <em>literally</em> a reason that your compiler chose to modify the code the way it did, and there is a <em>completely understandable chain of events</em> that lead to the unexpected outcome. You might not know what that reason is, but that doesn't make it random chance. It was incorrect assumptions on the programmer's end, combined with a strict boundary for what constitutes "valid state and behavior" in a system that, while outside the programmer's control, <em>is</em> in <em>somebody's</em> control. I think this perspective made more sense back when there were less protections around memory access (e.g. read/write/execute flags), but I certainly don't think it holds to the same degree today.<p>Undefined behavior - the tangible <em>consequences</em> of violating a language's rules and assumptions - is obfuscated by the fact that it's a <a href=https://en.wikipedia.org/wiki/Negative_space rel=noopener target=_blank>negative space</a> of sorts. I think it's easy to lose sight of the boundary itself and assume that something is UB just because it's relatively close to that boundary. Even reading Rust's specifications isn't enough - words themselves are open to interpretation, whereas the boundary <em>literally</em> isn't. Even if it hasn't been vocally defined, even if nobody knows that it's there, it still exists. The program either violates the compiler's assumptions or it doesn't. It is not random chance whether a program <em>can</em> or <em>cannot</em> produce undefined behavior, even if the consequences manifest sporadically. Assuming compilers are deterministic, UB is also consistent in the sense that if you change nothing about your program and compiler, that miscompilation will continue to happen.<p>Whew, that was quite the tangent. Hopefully that makes it clear <em>why</em> I would bother doing something like this in the first place. I won't be fully satisfied with any solution I choose until I tie up this loose end and figure out if it works or not. Even if it's not the best solution in this exact case, I'll still have learned something about the boundary of undefined behavior.<h2 id=the-partial-borrow-problem>The partial borrow problem<a aria-hidden=true class=anchor hidden href=#the-partial-borrow-problem>#</a></h2><p>I started looking into this due to borrow-checker wrestling in the Starcraft Simulator, specifically when adding in buffs/debuffs. We have a <code>Coordinator</code> struct, which contains 2 <code>Army</code> structs (and some miscellaneous metadata). Each <code>Army</code> struct looks roughly like this:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-keyword z-rust">struct</span> <span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Army</span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    </span></span><span class="z-keyword z-operator z-range z-rust">...</span>
</span><span class="z-source z-rust">    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-local z-rust">base_units</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-storage z-type z-any z-rust">Map</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-identifier z-rust">Base</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-identifier z-rust">Unit</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-separator z-rust">,</span>
</span><span class="z-source z-rust">    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-local z-rust">units</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-identifier z-rust">State</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-separator z-rust">,</span>
</span><span class="z-source z-rust">    <span class="z-keyword z-operator z-range z-rust">...</span>
</span><span class="z-source z-rust">}
</span></code></pre><p><code>base_units</code> is a hashmap that contains the immutable stats of each unit type (max health, what weapons the unit can use, etc.). <code>units</code> is a flat vec, accessed via integer handles, and contains all of the data that can change over the course of a fight. It's important to note that this is a "setup -> run -> inspect" situation. Once the setup phase is complete, <code>.base_units</code> and <code>.units</code> will never change size (and thus never be reallocated), are never rearranged, and the contained structs are never assigned to, only individual fields in those structs (e.g. never <code>army.units[i] = ...</code>, only <code>army.units[i].field = ...</code>). For now we can pretend state looks like this:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-keyword z-rust">struct</span> <span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">State</span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">max_speed</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-identifier z-rust">Real</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">effects</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-identifier z-rust">Effect</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>What I want to implement is Concussive Shell, a non-stacking debuff on the marauder's attack that slows any unit it hits by 50%. These types of stat modifiers are represented in memory by the <code>Effect</code> enum. As this is a prototype, <code>Effect</code> only has one variant, so we can pretend it's actually just a struct that looks like this:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-keyword z-rust">struct</span> <span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Effect</span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">stat</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-identifier z-rust">Stat</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">apply</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-function z-rust">fn</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-identifier z-rust">State</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">timestamp</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-identifier z-rust">Real</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-keyword z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Effect</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-keyword z-const z-rust">const</span> <span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> <span class="z-entity z-name z-function z-rust">concussive</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">timestamp</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-identifier z-rust">Real</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-keyword z-other z-self z-rust">Self</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-other z-self z-rust">Self</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-variable z-local z-rust">stat</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">Stat</span><span class="z-punctuation z-accessor z-rust">::</span><span class="z-storage z-type z-enum z-rust">Speed</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-variable z-local z-rust">apply</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">|</span><span class="z-variable z-local z-rust">state</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-storage z-type z-source z-rust">State</span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-variable z-local z-rust">state</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">max_speed</span> <span class="z-keyword z-operator z-assignment z-rust">*=</span> <span class="z-support z-macro z-rust">const_real!</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-float z-rust">0.5</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-variable z-local z-rust">timestamp</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><code>stat</code> tells us which part of <code>State</code> is being modified (useful when we remove the effect). <code>timestamp</code> is the time at which the <code>Effect</code> wears off and needs to be removed. Each tick, the coordinator checks the timestamps of each effect on each unit in each army, and removes the effect when necessary. "Removing an effect" in this instance isn't as straightforward as just setting the stat back to its default value, as we need to consider units with multiple effects that each modify the same stat (e.g. a zealot whose speed is boosted by charge, but lowered by concussive shell). The simplest way I could think to do this was by fully recalculating the stat each time a modifier is removed. There aren't a whole lot of buffs/debuffs in starcraft, and as far as I know there aren't any that stack, so I don't think it's the end of the world computationally or storage-wise.<p>That manifests in the <code>Coordinator</code>, with the following function:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> coordinator.rs
</span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> <span class="z-entity z-name z-function z-rust">tick_effects</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> eliminates code duplication. The closure also captures (thus partial
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> borrows) any other part of `self` that might be used.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-local z-rust">_inner</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">|</span><span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-storage z-type z-source z-rust">Army</span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">unit</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">units</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> &LT-- first borrow
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-local z-rust">i</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-keyword z-control z-rust">while</span> <span class="z-variable z-local z-rust">i</span> <span class="z-keyword z-operator z-comparison z-rust"><</span> <span class="z-variable z-local z-rust">unit</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">effects</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">len</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-keyword z-control z-rust">if</span> <span class="z-variable z-local z-rust">unit</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">effects</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">i</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">timestamp</span> <span class="z-keyword z-operator z-comparison z-rust"><=</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">time</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                    <span class="z-variable z-local z-rust">unit</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">effects</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">swap_remove</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">i</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                    <span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">reset_speed</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">unit</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> &LT-- uh oh
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> swap remove means we don't need to increment i
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                    <span class="z-variable z-local z-rust">i</span> <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-function z-rust">_inner</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">red</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-function z-rust">_inner</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">blu</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>Iterating over <code>army.units</code> holds a borrow over <code>army</code>. A call to <code>army.reset_speed(unit)</code> requires borrowing <code>&mut army</code> as well, resulting in a compiler error.<p>A similar problem manifests in <code>reset_speed()</code>. As a reminder, in this is a prototype we're only dealing with the speed stat, but it won't always be that way. These functions have a bit of added complexity when dealing with other stat types, which is why we'll need a full mutable borrow on <code>state</code> if we want <code>effect.apply</code> to be fully "generic".<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> army.rs
</span></span><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span><span class="z-punctuation z-section z-group z-end z-rust">)</span> <span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> <span class="z-entity z-name z-function z-rust">reset_speed</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-variable z-parameter z-rust">state</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-identifier z-rust">State</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">speed</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">base_units</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-variable z-local z-rust">state</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">base</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">movement</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">speed</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-local z-rust">state</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">max_speed</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-local z-rust">speed</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">effect</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-variable z-local z-rust">state</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">effects</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> &LT-- first borrow
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-local z-rust">effect</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">apply</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">state</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> &LT- uh oh
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>Same deal, <code>&state.effects</code> borrows from <code>state</code>, but we also need to pass <code>state</code> mutably into <code>effect.apply</code>.<blockquote><p>Aside: I know these can both be solved in safe rust via indexing, but as I said before, this is at least partially an academic pursuit. It's also worth noting that this has some ergonomic downsides, since I can't use iterator methods like <code>.filter()</code>. I'll include the safe versions of these functions later on after we talk more about the compiler.</blockquote><p>This is where the escape hatch comes in. As the <em>programmer</em>, this is a pretty trivial case. With <code>state</code> being the same as <code>army.units[i]</code>, we <em>really</em> only have:<ul><li>a read from <code>state.base</code> (which is just a <code>Copy</code> enum)<li>a read from <code>army.base_units[base].movement.speed</code><li>a write to <code>state.effects</code> immediately before <code>reset_speed</code><li>a read from <code>state.effects</code> within <code>reset_speed</code><li>a write to <code>state.max_speed</code> (or some other stat that is guaranteed not to overlap with <code>state.effects</code>) within <code>effect.apply</code></ul><p>None of these conflict in an absolute sense - we're not changing any values that we already have an immutable reference to, and none of the mutable values overlap. In C it would be trivial to hook this up, and it would look pretty similar to a Rust implementation that used free functions. To get the same behavior via Rust we can bypass the borrow checker using raw pointers. To maintain regular Rust ergonomics, we can turn the pointer <strong>back into a ref</strong>. Note that the return-type coerces the lifetime to a <em>different</em> lifetime than the value passed in.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> <span class="z-entity z-name z-function z-rust">unsafe_ref</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'b</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-identifier z-rust">T</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">val</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-identifier z-rust">T</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'b</span> <span class="z-identifier z-rust">T</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">val</span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-modifier z-rust"><span class="z-keyword z-operator z-symbol z-rust">*</span>const</span> <span class="z-storage z-type z-rust">T</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">as_ref</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">unwrap</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> <span class="z-entity z-name z-function z-rust">unsafe_mut</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'b</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-identifier z-rust">T</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">val</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-identifier z-rust">T</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'b</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-identifier z-rust">T</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">val</span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-modifier z-rust"><span class="z-keyword z-operator z-symbol z-rust">*</span>mut</span> <span class="z-storage z-type z-rust">T</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">as_mut</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">unwrap</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> coordinator.rs
</span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> <span class="z-entity z-name z-function z-rust">tick_effects</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-local z-rust">_inner</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">|</span><span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-storage z-type z-source z-rust">Army</span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">unit</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-function z-rust">unchecked_mut</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">units</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-operator z-range z-rust">...</span>
</span></span></span></span></span></code></pre><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> army.rs
</span></span><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> <span class="z-entity z-name z-function z-rust">reset_speed</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-variable z-parameter z-rust">state</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-identifier z-rust">State</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">speed</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">base_units</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-variable z-local z-rust">state</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">base</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">movement</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">speed</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-local z-rust">state</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">max_speed</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-local z-rust">speed</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">effect</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-function z-rust">unchecked_ref</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-variable z-local z-rust">state</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">effects</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> no borrow checker error
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-local z-rust">effect</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">apply</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">state</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>If I was purely working in raw pointers, that would be the end of the story I think, as raw pointers don't carry the same guarantees as mutable references. The fact that I'm casting it back to a reference <em>and</em> I'm "using" other references to the struct is the real issue.<p>To be clear, this is already very unsafe. Any mistakes in logic <em>will</em> result in UB, even if accessing the <code>unsafe_mut</code> ref and <code>&mut self</code> at the same time isn't instant UB by itself. It's not just bypassing the borrow checker, we're giving it the middle finger. Rust will continue to uphold borrow checker rules about <code>val</code> <em>as if <code>val</code> is not currently accessible anywhere else</em>, so any incorrect assumptions are very dangerous.<p>With these functions we no longer have to hold borrows to <code>army</code> and <code>state</code> while iterating over <code>army.units</code> and <code>state.effects</code>. That frees us up to call methods and pass them around without any trouble. At least, without any trouble from the <em>borrow checker</em>. Compiler trouble is another issue.<p>Fun note, after starting this blog post I found another repo using similar functions in the wild: <a href=https://github.com/amazon-ion/ion-rust/blob/main/src/unsafe_helpers.rs rel=noopener target=_blank>amazon's official Rust parser for the Ion data format</a>. It's not quite the same since the behavior is split between two functions, but I still thought it was a funny coincidence.<h2 id=but-is-there-undefined-behavior>But is there undefined behavior?<a aria-hidden=true class=anchor hidden href=#but-is-there-undefined-behavior>#</a></h2><p>It's complicated. My gut instinct was "no". After reading the docs for raw pointers it was "probably yes". After consulting some community members, we agreed "almost definitely yes". After doing a few nights of research and a lot of staring at a wall, my answer was "probably no". Now though? My answer is "who knows". And that's kind of a genuine question. I don't think this information is centralized anywhere aside from a few people's brains, and that <em>might</em> be intentional. Researching this took me down quite a few rabbit holes, stretching my knowledge of compilers pretty well past its breaking point. Forgive me if I've misunderstood or misinterpreted things. As I'm doing my "final" pass before posting this, I am <em>still</em> reading literature from experts about how this sort of thing works. This turned from a "I'm gonna take a day to whine about this minor annoyance in my fruit salad text" to "oh god it's been weeks and I'm still rewriting sections". Take all of this with the largest grain of salt you can find. If anything major is pointed out, I'll edit the post.<h3 id=rust-s-rules>Rust's Rules<a aria-hidden=true class=anchor hidden href=#rust-s-rules>#</a></h3><p>The first place to look is <a href=https://doc.rust-lang.org/std/ptr/index.html rel=noopener target=_blank>std::ptr</a>, which offers this bit of wisdom:<blockquote><p>Whether a pointer is valid depends on the operation it is used for (read or write), and the extent of the memory that is accessed (i.e., how many bytes are read/written) – it makes no sense to ask “is this pointer valid”; one has to ask “is this pointer valid for a given access”</blockquote><p>I hinted at this above when describing the escape hatch in terms of reads and writes rather than pointers. This is echoed in a <a href=https://faultlore.com/blah/fix-rust-pointers/ rel=noopener target=_blank>fantastic blog post by the author of the nomicon and Learning Rust With Entirely Too Many Linked Lists</a>:<blockquote><p>The primary function of aliasing is as a model for when the compiler can semantically cache memory accesses. This can either mean assuming a value in memory hasn’t been modified or assuming a write to memory isn’t necessary...Now it’s often clumsy to talk about accesses aliasing, so we usually talk about pointers aliasing as a shorthand... The reason that the actual model is in terms of accesses and not pointers is because that’s the thing that we care about.</blockquote><p>Since passing around the pointers doesn't matter if we don't use them, getting a ref via <code>unsafe_mut</code> and then calling a function that takes <code>&mut self</code> <em>and</em> that unsafe ref likely isn't UB so long as we don't access <code>&mut self</code>.<p>Back to the pointer documentation:<blockquote><p>The precise rules for validity are not determined yet.</blockquote><p>Oh. Well shit.<p>This is a large part of why I can't put a 100% guarantee on anything I'm saying. <em>The language itself</em> isn't making guarantees, and experts are still investigating various parts of the semantics to this day. I am <em>not</em> an expert, I'm just a dude who spends inordinate amounts of his free time investigating stupid things for stupid reasons. As such, I will continue to dig, as I think I can make a more solid case than "Iunno, it seems fine". Not <em>too</em> much more solid though, as we're diving directly into semantics hell.<p>Since all of my refs are derived from pointers which are derived from valid refs, and this is a single-threaded application, the only relevant part of the minimal outline given by the pointer documentation is the last one:<blockquote><p>The result of casting a reference to a pointer is valid for as long as the underlying object is live and no reference (just raw pointers) is used to access the same memory. That is, reference and pointer accesses cannot be interleaved.</blockquote><p>Which doesn't actually help that much. In this case I think we can assume that ref -> ptr -> ref is functionally identical to ref -> ptr. We access <code>army.units</code> through a pointer, and <code>state.effects</code> through a pointer, but that's interleaved with a regular <code>&mut army</code> to call <code>reset_speed</code> and check a value in <code>army.base_units</code>. In the blog post I linked earlier, she says that "<em>generally</em> you should avoid mixing references and unsafe pointers". So uh, that doesn't quite give a firm yes or no either, and somewhat contradicts the official docs. I think this has to do with stacked borrows (i.e. how miri currently tracks memory access), but I'm not going to get into that here because it's a whole can of worms.<p>But what does accessing "the same memory" mean exactly? For that matter, what does "access" mean? It's easy to say "a read or a write", but what does <em>that</em> mean? If I pass <code>&mut army</code> to a method, does that access the pointer? In my eyes, unless the method is dynamically dispatched I don't think anything physically in memory is being read or written, and that's what matters according to the Rust and LLVM docs. What about accessing a <em>field</em> of <code>army</code>? Does that count as reading the whole struct, or just the field? In a local scope it only accesses the field, but is that a special compiler trick?<p>The opinion of the community members I asked was that <code>&mut army</code> effectively <em>does</em> count as accessing all of <code>army</code>, regardless of how it's used in the function. This was explained via <a href=https://doc.rust-lang.org/nomicon/borrow-splitting.html rel=noopener target=_blank>split_at_mut</a>, and how it returns 2 <em>new</em> objects at the same time, thus only ever requiring 1 borrow of the original slice. The more I think about that, the less I agree with it though. I think that it works that way so that it is 100% safe - the intention of <code>split_at_mut</code> is that you cannot access the original slice while you're accessing the 2 halves of it. But not being 100% safe doesn't immediately mean UB.<p>Another thread we can investigate is the rust reference's section on <a href=https://doc.rust-lang.org/reference/behavior-considered-undefined.html rel=noopener target=_blank>Behavior Considered Undefined</a>. It's not exhaustive, but still has some new info we haven't covered yet. To quickly run down the list:<ul><li>We have no data races because it's single threaded<li>The pointers are made from valid refs, so they cannot be dangling or misaligned<li>We're accessing fields through regular <code>.</code> syntax, so we cannot violate in-place pointer arithmetic rules<li>We <em>might</em> be breaking LLVM's pointer aliasing rules, especially since we're not using <code>UnsafeCell</code>, but I'll talk about this one in more detail below<li>We <em>might</em> be mutating "immutable" bytes? This has to do with "pointer provenance transitivity" (holy hell), which I'll get into later<li>We're not using compiler intrinsics<li>We're not cross compiling or using architecture-specific features<li>We're not interacting with any external functions, so there's nowhere to use the wrong ABI in a function call<li>We're not producing any invalid values<li>We're not using inline assembly<li>This is not a const context</ul><h3 id=llvm-s-rules>LLVM's rules<a aria-hidden=true class=anchor hidden href=#llvm-s-rules>#</a></h3><p>The two rules that we might be breaking depend on what it means for a pointer value is "based on" another pointer value. The main statement we're worried about is <a href=https://llvm.org/docs/LangRef.html#pointer-aliasing-rules rel=noopener target=_blank>this</a>:<blockquote><p>Pointer Aliasing Rules: Any memory access must be done through a pointer value associated with an address range of the memory access, otherwise the behavior is undefined... A pointer value is associated with the addresses associated with any value it is <em>based</em> on... A pointer value formed from a scalar <code>getelementptr</code> operation is <em>based</em> on the pointer-typed operand of the <code>getelementptr</code>... The "<em>based on</em>" relationship is transitive.</blockquote><p>The wording of "based on" is a bit obtuse, but I assume it's the same thing as what the Rust docs call <a href=https://doc.rust-lang.org/std/ptr/index.html#provenance rel=noopener target=_blank>"provenance"</a>, and it involves the (apparently) infamous <a href=https://llvm.org/docs/LangRef.html#getelementptr-instruction rel=noopener target=_blank>getelementptr</a> LLVM instruction. The reference straight up says that the instruction is very confusing, and has <a href=https://llvm.org/docs/GetElementPtr.html rel=noopener target=_blank>dedicated documentation to clarify things</a> that is <em>also</em> very confusing. To be fair, that's not LLVM's fault, it's mine for digging into this without the requisite contextual knowledge.<p>The one hitch in this is that the Rust docs talk about "shrinking" provenance, which seems to somewhat contradict the LLVM docs' "associated with the addresses associated with any value it is based on":<blockquote><p>Provenance is implicitly shared with all pointers transitively derived from The Original Pointer through operations like offset, borrowing, and pointer casts. Some operations may shrink the derived provenance, limiting how much memory it can access or how long it’s valid for (i.e. borrowing a subfield and subslicing).</blockquote><p>To sum up my understanding of this, <code>&mut foo.bar</code> counts as being associated with all of <code>&mut foo</code>, since the operand of <code>getelementptr</code> is the pointer to <code>foo</code>. Any subset pointer (e.g. <code>&mut bar.baz</code>) is also associated with all of <code>&mut foo</code> due to transitivity. <strong>But</strong> GEP-ing a field restricts the memory range that pointer the is allowed to access to some subset of <code>foo</code>. I read this as meaning that accessing data within <code>foo</code> via those pointers <em>at all</em> is valid, but it's invalid to take a pointer to <code>foo2</code> and offset it such that writing to it will write to <code>foo.bar</code>.<p>As far as I can tell, this says nothing about how and when the pointed-to data can be accessed if you have multiple pointers to that same data, only that LLVM expects to be able to "know" where each pointer came from, and that its access is in-bounds. In strict terms, <a href=https://llvm.org/docs/GetElementPtr.html#what-is-dereferenced-by-gep rel=noopener target=_blank>GEP is just pointer arithmetic</a>, <em>not</em> an access. To put it in a more intuitive way, I think LLVM expects to be able to "undo" any pointer arithmetic to figure out what the base pointer is. If I understand correctly, LLVM doesn't have the concept of types or objects when referring to pointers, only addresses and access ranges, so I <em>think</em> this logic tracks.<p>The next hint we get is from the <a href=https://llvm.org/docs/LangRef.html#noalias rel=noopener target=_blank>LLVM's documentation of <code>noalias</code></a> which states:<blockquote><p>Memory locations accessed via pointer values <em>based</em> on the argument or return value are not also accessed, during the execution of the function, via pointer values not <em>based</em> on the argument or return value. This guarantee only holds for memory locations that are <em>modified</em>...The attribute on a return value also has additional semantics...On function return values, the <code>noalias</code> attribute indicates that the function acts like a system memory allocation function, returning a pointer to allocated storage disjoint from the storage of any other object accessible to the caller.</blockquote><p>This specifically deals with argument and return pointers, and that mutably accessing data is allowed (even under <code>noalias</code>) so long as it's only ever accessed by pointers <em>based on</em> the argument/return value. Honestly, the wording on this is pretty bad. I have 2 mutable pointers, and they are both clearly based on the same <code>self.army</code>, and (in theory) both <em>could</em> access the same data. Remember when I said semantics hell? Prepare yourself, this one's a disaster. LLVM's wording can be read in 2 different ways:<ul><li>Pessimistically, if a <code>noalias</code> pointer is passed into a function, any and all accesses to those bits must be made from pointers that are GEP'd from the passed-in-pointer <em>within the function</em> (i.e. nothing else passed in can access those bits, and no globals can either)<li>Optimistically, if 2 <code>noalias</code> pointers are passed into a function and both point to the same memory, accesses are fine so long as they are both "obviously" based on the same pointer</ul><p>Part of the reason this ambiguity exists is because LLVM docs say that <code>noalias</code> is "intentionally <strong>similar to</strong> the definition of <code>restrict</code> in C99". C99 <code>restrict</code> is what allows the compiler to cache memory reads when multiple pointers are passed to a function. If it said it was "identical to", I could for sure say "okay, the pessimistic take is the correct one". Instead, well... I don't know. The optimistic take <em>could</em> be true if LLVM is smart enough to do meta-analysis on individual call-sites and ignore the <code>noalias</code> declaration (and thus <code>noalias</code>-based optimizations) where appropriate. That <em>could</em> be a ridiculous line of reasoning, but to me it doesn't sound that farfetched considering how explicit the "based on" relationship is when using GEP, and this <a href=https://www.ralfj.de/blog/2022/04/11/provenance-exposed.html rel=noopener target=_blank>whole article</a> that talks about how the "based on" relationship <em>is</em> tracked to some degree, and that certain operations can muddy that tracking. It all depends on if <code>noalias</code> is treated as an invariant guaranteed by the programmer, or as a hint that allows <em>potential</em> optimization.<p>Finally, we can look at the <a href=https://llvm.org/docs/LangRef.html#noalias-and-alias-scope-metadata rel=noopener target=_blank>definitions of the <code>!noalias</code> and <code>!alias.scope</code></a> decorators in LLVM's intermediate representation:<blockquote><p><code>!noalias</code> and <code>!alias.scope</code> metadata provide the ability to specify generic noalias memory-access sets. This means that some collection of memory access instructions (loads, stores, memory-accessing calls, etc.) that carry <code>!noalias</code> metadata can specifically be specified not to alias with some other collection of memory access instructions that carry <code>!alias.scope</code> metadata.</blockquote><p>What this allows is the defining of selective aliasing of non-argument/return value pointers. Adding these attributes to a pointer creates the fine-grained control of "this pointer might alias with any other pointer in the program, but it <em>can</em> be guaranteed not to alias with <em>this other pointer</em> (or set of pointers) right here".<p>To sum all of this up:<ul><li>Pointers, according to LLVM, are an address and the number of bytes they can access<li>GEP (i.e. getting a reference to a struct's field from a reference to a struct) is just pointer arithmetic and does not count as a read or write<li>All of the below rules are ~irrelevant if you only ever access via 1 pointer<li>(assuming the conservative interpretation) <code>noalias</code> on a pointer passed into a function assumes the pointed-to-value is not modified via anything other the passed-in-pointer <strong>during the function</strong><li><code>noalias</code> on a return pointer means that the <em>caller</em> assumes the pointer is completely unique (and thus cannot be accessed via any other previously existing pointer)<li>LLVM does &LTsome form of meta analysis> that tracks pointers at least a little bit, and applies <code>!noalias</code> and <code>!alias.scope</code> within (and across) functions to make explicit aliasing relationships</ul><h3 id=llvm-ir>LLVM IR<a aria-hidden=true class=anchor hidden href=#llvm-ir>#</a></h3><p>All of the above information is very cool, but none of it means anything if we don't know how Rust is communicating with LLVM, and thus how LLVM sees our code. Even looking at the raw assembly won't help, since these are invariants that are reflected through Rust semantics and LLVM-IR decorators. Luckily, <code>cargo-show-asm</code> also has output for both LLVM-IR and pre-pass LLVM-IR. The latter is essentially before any optimizations or code transformations, and it doesn't contain any <code>!noalias</code> or <code>!alias.scope</code> decorators. While we can view the <code>reset_speed</code> and <code>tick_effects</code> functions both pre- and post-pass, <code>unsafe_mut</code> doesn't actually <em>do</em> anything and thus is optimized out (even with <code>#[inline(never)]</code>). That means we can only view it pre-pass:<pre class="language-llvm z-code" data-lang=llvm><code class=language-llvm data-lang=llvm><span class="z-source z-llvm"><span class="z-keyword z-llvm">define</span> <span class="z-keyword z-metadata z-llvm">internal</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">24</span><span class="z-punctuation z-llvm">)</span> <span class="z-type z-llvm">ptr</span> <span class="z-punctuation z-llvm">@</span><span class="z-function z-name z-llvm">sc2_sim::utils::unsafe_mut</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">24</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%val</span><span class="z-punctuation z-llvm">)</span> <span class="z-keyword z-metadata z-llvm">unnamed_addr</span> #<span class="z-constant z-llvm">7</span> <span class="z-punctuation z-llvm">{</span>
</span><span class="z-source z-llvm">start:
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_2</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">alloca</span> <span class="z-punctuation z-llvm">[</span><span class="z-constant z-llvm">8</span> x <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.lifetime.start.p0</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_2</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_5</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">ptrtoint</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%val</span> <span class="z-keyword z-instruction z-misc z-llvm">to</span> <span class="z-type z-llvm">i64</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%0</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_5</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%0</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb1</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb2</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb1:                                              <span class="z-comment z-llvm">; preds = %start
</span></span><span class="z-source z-llvm"><span class="z-comment z-llvm">; call core::option::unwrap_failed
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-function z-name z-llvm">core::option::unwrap_failed</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">readonly</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">24</span><span class="z-punctuation z-llvm">)</span> <span class="z-punctuation z-llvm">@</span>alloc_f8a1d20999d2bdc92f370757a18e4787<span class="z-punctuation z-llvm">)</span> #<span class="z-constant z-llvm">23</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">unreachable</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb2:                                              <span class="z-comment z-llvm">; preds = %start
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-misc z-llvm">store</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%val</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_2</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_0</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">ptr</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_2</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!nonnull</span> <span class="z-tags z-llvm">!2</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!align</span> <span class="z-tags z-llvm">!4</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!2</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.lifetime.end.p0</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_2</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">ret</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_0</span>
</span><span class="z-source z-llvm"><span class="z-punctuation z-llvm">}</span>
</span></code></pre><p>Wow, that certainly is some syntax...<blockquote><p>Aside: The blog-builder I use didn't even have highlighting for it, and there isn't a sublime-syntax for it that I could find in the wild. I tried some vscode extensions to get a feel for what it might look like, but those could only really manage "everything's a variable or a keyword" which is... unhelpful. Syntax highlighting should at least hint at the relationships between various tokens. In the end I just went ahead and wrote a sublime-syntax file myself that hopefully isn't quite so hideous.</blockquote><p>In particular, I want to point out 2 things. First is that the returned value is literally a copy of the passed in value.<pre class="language-llvm z-code" data-lang=llvm><code class=language-llvm data-lang=llvm><span class="z-source z-llvm"><span class="z-comment z-llvm">; after this, metadata tags are added and it's "copied" to the
</span></span><span class="z-source z-llvm"><span class="z-comment z-llvm">; memory address of the return value, but this is where the value
</span></span><span class="z-source z-llvm"><span class="z-comment z-llvm">; comes from. It is NOT an inttoptr or ptrtoint
</span></span><span class="z-source z-llvm"><span class="z-keyword z-instruction z-misc z-llvm">store</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%val</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_2</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span>
</span></code></pre><p>I'm not 100% sure if this (and/or this getting optimized out) ends up erasing the "based on" relationship of the original pointer somewhere along the line, but I don't think so.<p>Second, and more importantly, is the return type of the function:<pre class="language-llvm z-code" data-lang=llvm><code class=language-llvm data-lang=llvm><span class="z-source z-llvm"><span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">24</span><span class="z-punctuation z-llvm">)</span> <span class="z-type z-llvm">ptr</span>
</span></code></pre><p>You'll notice that it does <em>not</em> have a <code>noalias</code> tag. That means we can ignore the return position <code>noalias</code> restrictions entirely. Also, the <code>dereferenceable(24)</code> refers to the number of bytes that the pointer is allowed to legally access. It's of size 24 because both of our <code>unsafe_mut</code> calls are references to vecs.<p>Before getting to the post-pass, it's worth noting that this is what a call to <code>into_iter</code> looks like in LLVM-IR:<pre class="language-llvm z-code" data-lang=llvm><code class=language-llvm data-lang=llvm><span class="z-source z-llvm"><span class="z-local z-llvm">%0</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-punctuation z-llvm">{</span> <span class="z-type z-llvm">ptr</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-punctuation z-llvm">}</span>
</span><span class="z-source z-llvm">    <span class="z-punctuation z-llvm">@</span><span class="z-string z-llvm">"<&mut alloc::vec::Vec&LTT,A> as core::iter::traits::collect::IntoIterator>::into_iter"</span><span class="z-punctuation z-llvm">(</span>
</span><span class="z-source z-llvm">        <span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">24</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%units</span>
</span><span class="z-source z-llvm">    <span class="z-punctuation z-llvm">)</span>
</span></code></pre><p>All it does is return pointers to the first element, and 1 past the last element of the passed-in array. <code>army.units</code> is considered noalias inside the function of <code>into_iter</code>, but <em>the return pointers are not</em>. That means LLVM does <em>not</em> expect <code>state</code> to be inaccessible by other existing pointers.<details><summary>Full tick_effects LLVM-IR</summary> <pre class="language-llvm z-code" data-lang=llvm><code class=language-llvm data-lang=llvm><span class="z-source z-llvm"><span class="z-comment z-llvm">; sc2_sim::coordinator::Coordinator::tick_effects
</span></span><span class="z-source z-llvm"><span class="z-comment z-llvm">; Function Attrs: noinline uwtable
</span></span><span class="z-source z-llvm"><span class="z-keyword z-llvm">define</span> <span class="z-keyword z-metadata z-llvm">internal</span> fastcc <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-function z-name z-llvm">sc2_sim::coordinator::Coordinator::tick_effects</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">nocapture</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">readonly</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">336</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">)</span> <span class="z-keyword z-metadata z-llvm">unnamed_addr</span> #<span class="z-constant z-llvm">2</span> <span class="z-punctuation z-llvm">{</span>
</span><span class="z-source z-llvm">start:
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_3</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">328</span> <span class="z-comment z-llvm">; offset self + time
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.experimental.noalias.scope.decl</span><span class="z-punctuation z-llvm">(</span><span class="z-keyword z-llvm">metadata</span> <span class="z-tags z-llvm">!679</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%0</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">8</span> <span class="z-comment z-llvm">; offset red + units heap ptr?
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%units.val.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">ptr</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%0</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!alias.scope</span> <span class="z-tags z-llvm">!679</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!nonnull</span> <span class="z-tags z-llvm">!5</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span> <span class="z-comment z-llvm">; deref to load units heap ptr?
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%1</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">16</span> <span class="z-comment z-llvm">; offset red + units.len?
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%units.val6.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i64</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%1</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!alias.scope</span> <span class="z-tags z-llvm">!679</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span> <span class="z-comment z-llvm">; deref/copy units.len
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%2</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> %<span class="z-string z-llvm">"army::State"</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%units.val.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%units.val6.i</span> <span class="z-comment z-llvm">; get a pointer to 1 past the end of the units.data
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%3</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%units.val6.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span> <span class="z-comment z-llvm">; if len = 0, exit
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%3</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"sc2_sim::coordinator::Coordinator::tick_effects::{{closure}}.exit", label %"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i.preheader"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i.preheader"</span>: <span class="z-comment z-llvm">; preds = %start
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_26.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i32</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_3</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-comment z-llvm">; load current time
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb3<span class="z-punctuation z-llvm">.</span>loopexit<span class="z-punctuation z-llvm">.</span>i:                                   <span class="z-comment z-llvm">; preds = %bb15.i, %"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i"
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%4</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_14.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%2</span> <span class="z-comment z-llvm">; if current == end, exit
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%4</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"sc2_sim::coordinator::Coordinator::tick_effects::{{closure}}.exit", label %"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i": ; preds = %"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i.preheader"</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb3.loopexit.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%iter.sroa.0.08.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">ptr</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_14.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb3.loopexit.i</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%units.val.i</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i.preheader"</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_14.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> %<span class="z-string z-llvm">"army::State"</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%iter.sroa.0.08.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">1</span> <span class="z-comment z-llvm">; index into units
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%5</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%iter.sroa.0.08.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">16</span> <span class="z-comment z-llvm">; get state
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_154.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i64</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%5</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!679</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span> <span class="z-comment z-llvm">; deref effect type?
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_135.not.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_154.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span> <span class="z-comment z-llvm">; if effect type isn't right, continue, else start the calculations
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%_135.not.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb3.loopexit.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.lr.ph.i"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.lr.ph.i": ; preds = %"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i"</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%6</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%iter.sroa.0.08.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">8</span> <span class="z-comment z-llvm">; offset unit + effects.data ptr
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.i"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.i": ; preds = %bb15.i, %"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.lr.ph.i"</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_159.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_154.i</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.lr.ph.i"</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_15.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb15.i</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%i.sroa.0.06.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">[</span> <span class="z-constant z-llvm">0</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.lr.ph.i"</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%i.sroa.0.1.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb15.i</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%.val.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">ptr</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%6</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!679</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!nonnull</span> <span class="z-tags z-llvm">!5</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span> <span class="z-comment z-llvm">; load effects.data heap addr
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_0.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-punctuation z-llvm">[</span><span class="z-constant z-llvm">0</span> x %<span class="z-string z-llvm">"effect::Effect"</span><span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%.val.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">0</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%i.sroa.0.06.i</span> <span class="z-comment z-llvm">; index effects
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%7</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i32</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_0.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!range</span> <span class="z-tags z-llvm">!405</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!679</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span> <span class="z-comment z-llvm">; load effects discriminant
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%trunc.not.not.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i32</span> <span class="z-local z-llvm">%7</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span> <span class="z-comment z-llvm">; if discriminant == 0, process, else continue
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%trunc.not.not.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb11.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb12.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb12<span class="z-punctuation z-llvm">.</span>i:                                           <span class="z-comment z-llvm">; preds = %"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.i"
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%8</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_0.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">4</span> <span class="z-comment z-llvm">; offset effects.timestamp
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%timestamp.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i32</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%8</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">4</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!679</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span> <span class="z-comment z-llvm">; deref timestamp
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%switch5.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">sgt</span> <span class="z-type z-llvm">i32</span> <span class="z-local z-llvm">%timestamp.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%_26.i</span> <span class="z-comment z-llvm">; if timestamp is lte time, process, else continue
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%switch5.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb17.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"alloc::vec::Vec&LTT,A>::swap_remove.exit.i"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb11<span class="z-punctuation z-llvm">.</span>i:                                           <span class="z-comment z-llvm">; preds = %"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.i"
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%9</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">add</span> <span class="z-keyword z-metadata z-llvm">nuw</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%i.sroa.0.06.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">1</span> <span class="z-comment z-llvm">; i += 1
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb15.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"alloc::vec::Vec&LTT,A>::swap_remove.exit.i"</span>: <span class="z-comment z-llvm">; preds = %bb12.i
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.experimental.noalias.scope.decl</span><span class="z-punctuation z-llvm">(</span><span class="z-keyword z-llvm">metadata</span> <span class="z-tags z-llvm">!682</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%count.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">add</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_159.i</span><span class="z-punctuation z-llvm">,</span> -<span class="z-constant z-llvm">1</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_11.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> %<span class="z-string z-llvm">"effect::Effect"</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%.val.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%count.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.memmove.p0.p0.i64</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">16</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%_0.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">16</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%_11.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">16</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i1</span> <span class="z-constant z-llvm">false</span><span class="z-punctuation z-llvm">)</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!685</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-misc z-llvm">store</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%count.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%5</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!alias.scope</span> <span class="z-tags z-llvm">!682</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!687</span>
</span><span class="z-source z-llvm"><span class="z-comment z-llvm">; call sc2_sim::army::Army::reset_speed
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-function z-name z-llvm">sc2_sim::army::Army::reset_speed</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">144</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">88</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%iter.sroa.0.08.i</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_15.pre.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i64</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%5</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!679</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb15.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb17<span class="z-punctuation z-llvm">.</span>i:                                           <span class="z-comment z-llvm">; preds = %bb12.i
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%10</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">add</span> <span class="z-keyword z-metadata z-llvm">nuw</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%i.sroa.0.06.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">1</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb15.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb15<span class="z-punctuation z-llvm">.</span>i:                                           <span class="z-comment z-llvm">; preds = %bb17.i, %"alloc::vec::Vec&LTT,A>::swap_remove.exit.i", %bb11.i
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_15.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_159.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb11.i</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_159.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb17.i</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_15.pre.i</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"alloc::vec::Vec&LTT,A>::swap_remove.exit.i"</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%i.sroa.0.1.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%9</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb11.i</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%10</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb17.i</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%i.sroa.0.06.i</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"alloc::vec::Vec&LTT,A>::swap_remove.exit.i"</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_13.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">ult</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%i.sroa.0.1.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%_15.i</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%_13.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.i"</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb3.loopexit.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"sc2_sim::coordinator::Coordinator::tick_effects::{{closure}}.exit"</span>: <span class="z-comment z-llvm">; preds = %bb3.loopexit.i, %start
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_11</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">144</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.experimental.noalias.scope.decl</span><span class="z-punctuation z-llvm">(</span><span class="z-keyword z-llvm">metadata</span> <span class="z-tags z-llvm">!688</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%11</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">152</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%units.val.i2</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">ptr</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%11</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!alias.scope</span> <span class="z-tags z-llvm">!688</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!nonnull</span> <span class="z-tags z-llvm">!5</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%12</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">160</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%units.val6.i3</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i64</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%12</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!alias.scope</span> <span class="z-tags z-llvm">!688</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%13</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> %<span class="z-string z-llvm">"army::State"</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%units.val.i2</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%units.val6.i3</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%14</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%units.val6.i3</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%14</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"sc2_sim::coordinator::Coordinator::tick_effects::{{closure}}.exit32", label %"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i5.preheader"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i5.preheader": ; preds = %"sc2_sim::coordinator::Coordinator::tick_effects::{{closure}}.exit"</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_26.i19</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i32</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_3</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i5"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb3<span class="z-punctuation z-llvm">.</span>loopexit<span class="z-punctuation z-llvm">.</span>i29:                                 <span class="z-comment z-llvm">; preds = %bb15.i25, %"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i5"
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%15</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_14.i.i.i7</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%13</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%15</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"sc2_sim::coordinator::Coordinator::tick_effects::{{closure}}.exit32", label %"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i5"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i5": ; preds = %"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i5.preheader"</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb3.loopexit.i29</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%iter.sroa.0.08.i6</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">ptr</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_14.i.i.i7</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb3.loopexit.i29</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%units.val.i2</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i5.preheader"</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_14.i.i.i7</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> %<span class="z-string z-llvm">"army::State"</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%iter.sroa.0.08.i6</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">1</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%16</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%iter.sroa.0.08.i6</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">16</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_154.i8</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i64</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%16</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!688</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_135.not.i9</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_154.i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%_135.not.i9</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb3.loopexit.i29</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.lr.ph.i10"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.lr.ph.i10": ; preds = %"&LTcore::slice::iter::IterMut&LTT> as core::iter::traits::iterator::Iterator>::next.exit.i5"</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%17</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%iter.sroa.0.08.i6</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">8</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.i11"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.i11": ; preds = %bb15.i25, %"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.lr.ph.i10"</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_159.i12</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_154.i8</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.lr.ph.i10"</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_15.i26</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb15.i25</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%i.sroa.0.06.i13</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">[</span> <span class="z-constant z-llvm">0</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.lr.ph.i10"</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%i.sroa.0.1.i27</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb15.i25</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%.val.i14</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">ptr</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%17</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!688</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!nonnull</span> <span class="z-tags z-llvm">!5</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_0.i.i.i15</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-punctuation z-llvm">[</span><span class="z-constant z-llvm">0</span> x %<span class="z-string z-llvm">"effect::Effect"</span><span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%.val.i14</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">0</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%i.sroa.0.06.i13</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%18</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i32</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_0.i.i.i15</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!range</span> <span class="z-tags z-llvm">!405</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!688</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%trunc.not.not.i16</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i32</span> <span class="z-local z-llvm">%18</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%trunc.not.not.i16</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb11.i31</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb12.i17</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb12<span class="z-punctuation z-llvm">.</span>i17:                                         <span class="z-comment z-llvm">; preds = %"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.i11"
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%19</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_0.i.i.i15</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">4</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%timestamp.i18</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i32</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%19</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">4</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!688</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%switch5.i20</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">sgt</span> <span class="z-type z-llvm">i32</span> <span class="z-local z-llvm">%timestamp.i18</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%_26.i19</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%switch5.i20</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb17.i30</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"alloc::vec::Vec&LTT,A>::swap_remove.exit.i21"</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb11<span class="z-punctuation z-llvm">.</span>i31:                                         <span class="z-comment z-llvm">; preds = %"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.i11"
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%20</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">add</span> <span class="z-keyword z-metadata z-llvm">nuw</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%i.sroa.0.06.i13</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">1</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb15.i25</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"alloc::vec::Vec&LTT,A>::swap_remove.exit.i21"</span>: <span class="z-comment z-llvm">; preds = %bb12.i17
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.experimental.noalias.scope.decl</span><span class="z-punctuation z-llvm">(</span><span class="z-keyword z-llvm">metadata</span> <span class="z-tags z-llvm">!691</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%count.i.i22</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">add</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_159.i12</span><span class="z-punctuation z-llvm">,</span> -<span class="z-constant z-llvm">1</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_11.i.i23</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> %<span class="z-string z-llvm">"effect::Effect"</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%.val.i14</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%count.i.i22</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.memmove.p0.p0.i64</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">16</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%_0.i.i.i15</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">16</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%_11.i.i23</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">16</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i1</span> <span class="z-constant z-llvm">false</span><span class="z-punctuation z-llvm">)</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!694</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-misc z-llvm">store</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%count.i.i22</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%16</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!alias.scope</span> <span class="z-tags z-llvm">!691</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!696</span>
</span><span class="z-source z-llvm"><span class="z-comment z-llvm">; call sc2_sim::army::Army::reset_speed
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-function z-name z-llvm">sc2_sim::army::Army::reset_speed</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">144</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%_11</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">88</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%iter.sroa.0.08.i6</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_15.pre.i24</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i64</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%16</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!688</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb15.i25</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb17<span class="z-punctuation z-llvm">.</span>i30:                                         <span class="z-comment z-llvm">; preds = %bb12.i17
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%21</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">add</span> <span class="z-keyword z-metadata z-llvm">nuw</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%i.sroa.0.06.i13</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">1</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb15.i25</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb15<span class="z-punctuation z-llvm">.</span>i25:                                         <span class="z-comment z-llvm">; preds = %bb17.i30, %"alloc::vec::Vec&LTT,A>::swap_remove.exit.i21", %bb11.i31
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_15.i26</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_159.i12</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb11.i31</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_159.i12</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb17.i30</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_15.pre.i24</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"alloc::vec::Vec&LTT,A>::swap_remove.exit.i21"</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%i.sroa.0.1.i27</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%20</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb11.i31</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%21</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb17.i30</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%i.sroa.0.06.i13</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"alloc::vec::Vec&LTT,A>::swap_remove.exit.i21"</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_13.i28</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">ult</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%i.sroa.0.1.i27</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%_15.i26</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%_13.i28</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> %<span class="z-string z-llvm">"&LTalloc::vec::Vec&LTT,A> as core::ops::index::Index&LTI>>::index.exit.i11"</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb3.loopexit.i29</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-string z-llvm">"sc2_sim::coordinator::Coordinator::tick_effects::{{closure}}.exit32": ; preds = %bb3.loopexit.i29, %"sc2_sim::coordinator::Coordinator::tick_effects::{{closure}}.exit"</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">ret</span> <span class="z-type z-llvm">void</span>
</span><span class="z-source z-llvm"><span class="z-punctuation z-llvm">}</span>
</span></code></pre></details><br><p>Next we'll want to check the callsites of the functions that consume refs based on unsafe refs - <code>reset_speed</code> and <code>effect.apply</code><pre class="language-llvm z-code" data-lang=llvm><code class=language-llvm data-lang=llvm><span class="z-source z-llvm"><span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-function z-name z-llvm">sc2_sim::army::Army::reset_speed</span><span class="z-punctuation z-llvm">(</span>
</span><span class="z-source z-llvm">    <span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">144</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%_11</span><span class="z-punctuation z-llvm">,</span>
</span><span class="z-source z-llvm">    <span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">88</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%iter.sroa.0.08.i6</span>
</span><span class="z-source z-llvm"><span class="z-punctuation z-llvm">)</span>
</span></code></pre><p>Both the pointer to <code>army</code> (<code>%_11</code>) and the pointer to <code>state</code> (<code>%iter.sroa.0.08.i6</code>) are marked as <code>noalias</code>, which seems like it might be an issue. If you consider it carefully, this doesn't actually violate LLVM's expectations. According to LLVM <code>&mut army</code> is simply a pointer to 144 bytes, and <code>&mut state</code> is a pointer to 88 bytes. We, as the programmer, know that these bytes do not overlap in any way, since <code>&mut state</code> is a pointer to a heap-allocated array element, whereas <code>coordinator</code> (and thus <code>army</code>) is on the stack. While <code>state</code> was originally accessed via an overlapping pointer to <code>army.units</code>, we have arranged things in such a way that no <em>writes</em> are made to any of the bytes that a pointer to <code>army.units</code> would imply (i.e. the 24 byte footprint of the vec itself) until control returns back to <code>tick_effects</code>.<details><summary>Full reset_speed LLVM-IR</summary> <pre class="language-llvm z-code" data-lang=llvm><code class=language-llvm data-lang=llvm><span class="z-source z-llvm"><span class="z-comment z-llvm">; sc2_sim::army::Army::reset_speed
</span></span><span class="z-source z-llvm"><span class="z-comment z-llvm">; Function Attrs: noinline uwtable
</span></span><span class="z-source z-llvm"><span class="z-keyword z-llvm">define</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-function z-name z-llvm">sc2_sim::army::Army::reset_speed</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">nocapture</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">readonly</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">144</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">88</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%state</span><span class="z-punctuation z-llvm">)</span> <span class="z-keyword z-metadata z-llvm">unnamed_addr</span> #<span class="z-constant z-llvm">2</span> personality <span class="z-type z-llvm">ptr</span> <span class="z-punctuation z-llvm">@</span>__CxxFrameHandler3 <span class="z-punctuation z-llvm">{</span>
</span><span class="z-source z-llvm">start:
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_6</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%state</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">86</span> <span class="z-comment z-llvm">; offset state + base
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_6.val</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_6</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">2</span> <span class="z-comment z-llvm">; deref base
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.experimental.noalias.scope.decl</span><span class="z-punctuation z-llvm">(</span><span class="z-keyword z-llvm">metadata</span> <span class="z-tags z-llvm">!491</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%0</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">120</span> <span class="z-comment z-llvm">; offset self + base_units
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_12.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i64</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%0</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!alias.scope</span> <span class="z-tags z-llvm">!491</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span> <span class="z-comment z-llvm">; load base_units len
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%1</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_12.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span> <span class="z-comment z-llvm">; if len == 0, return
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%1</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb11</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb6.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm"><span class="z-comment z-llvm">; hash function
</span></span><span class="z-source z-llvm">bb6<span class="z-punctuation z-llvm">.</span>i:                                            <span class="z-comment z-llvm">; preds = %start
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_5</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">96</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_3.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">zext</span> <span class="z-keyword z-metadata z-llvm">nneg</span> <span class="z-type z-llvm">i8</span> <span class="z-local z-llvm">%_6.val</span> <span class="z-keyword z-instruction z-misc z-llvm">to</span> <span class="z-type z-llvm">i64</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_5.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">xor</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_3.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">1376283091369227076</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_8.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">zext</span> <span class="z-keyword z-metadata z-llvm">nneg</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_5.i.i.i.i</span> <span class="z-keyword z-instruction z-misc z-llvm">to</span> <span class="z-type z-llvm">i128</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_7.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">mul</span> <span class="z-keyword z-metadata z-llvm">nuw</span> <span class="z-keyword z-metadata z-llvm">nsw</span> <span class="z-type z-llvm">i128</span> <span class="z-local z-llvm">%_8.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">6364136223846793005</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_12.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">lshr</span> <span class="z-type z-llvm">i128</span> <span class="z-local z-llvm">%_7.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">64</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_41.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">xor</span> <span class="z-type z-llvm">i128</span> <span class="z-local z-llvm">%_12.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%_7.i.i.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_4.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">trunc</span> <span class="z-type z-llvm">i128</span> <span class="z-local z-llvm">%_41.i.i.i.i</span> <span class="z-keyword z-instruction z-misc z-llvm">to</span> <span class="z-type z-llvm">i64</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_8.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">and</span> <span class="z-type z-llvm">i128</span> <span class="z-local z-llvm">%_41.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">18446744073709551615</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_7.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">mul</span> <span class="z-keyword z-metadata z-llvm">nuw</span> <span class="z-keyword z-metadata z-llvm">nsw</span> <span class="z-type z-llvm">i128</span> <span class="z-local z-llvm">%_8.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">2611923443488327891</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_13.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">lshr</span> <span class="z-type z-llvm">i128</span> <span class="z-local z-llvm">%_7.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">64</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_51.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">xor</span> <span class="z-type z-llvm">i128</span> <span class="z-local z-llvm">%_13.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%_7.i.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_5.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">trunc</span> <span class="z-type z-llvm">i128</span> <span class="z-local z-llvm">%_51.i.i.i</span> <span class="z-keyword z-instruction z-misc z-llvm">to</span> <span class="z-type z-llvm">i64</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%2</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.fshl.i64</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_5.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_5.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_4.i.i.i.i</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%self.val.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">ptr</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_5</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!alias.scope</span> <span class="z-tags z-llvm">!494</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!497</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!nonnull</span> <span class="z-tags z-llvm">!5</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%3</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">104</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%self.val1.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i64</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%3</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!alias.scope</span> <span class="z-tags z-llvm">!499</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!497</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_18.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">lshr</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%2</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">57</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%h2_hash.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">trunc</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_18.i.i.i.i</span> <span class="z-keyword z-instruction z-misc z-llvm">to</span> <span class="z-type z-llvm">i8</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%.sroa.0.0.vec.insert.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">insertelement</span> <<span class="z-constant z-llvm">16</span> x <span class="z-type z-llvm">i8</span>> <span class="z-keyword z-llvm">poison</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> <span class="z-local z-llvm">%h2_hash.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">0</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%.sroa.0.15.vec.insert.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">shufflevector</span> <<span class="z-constant z-llvm">16</span> x <span class="z-type z-llvm">i8</span>> <span class="z-local z-llvm">%.sroa.0.0.vec.insert.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <<span class="z-constant z-llvm">16</span> x <span class="z-type z-llvm">i8</span>> <span class="z-keyword z-llvm">poison</span><span class="z-punctuation z-llvm">,</span> <<span class="z-constant z-llvm">16</span> x <span class="z-type z-llvm">i32</span>> <span class="z-keyword z-llvm">zeroinitializer</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%invariant.gep.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-punctuation z-llvm">{</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span><span class="z-constant z-llvm">7</span> x <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"unit::Unit"</span> <span class="z-punctuation z-llvm">}</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self.val.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> -<span class="z-constant z-llvm">1</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb1.i.i.i.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb1<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i:                                      <span class="z-comment z-llvm">; preds = %bb11.i.i.i.i, %bb6.i
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%hash.pn.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%2</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb6.i</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%12</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb11.i.i.i.i</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%probe_seq1.sroa.0.0.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i64</span> <span class="z-punctuation z-llvm">[</span> <span class="z-constant z-llvm">0</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb6.i</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%11</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb11.i.i.i.i</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%probe_seq.sroa.0.0.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">and</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%hash.pn.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%self.val1.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_5.i.i.i3.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self.val.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%probe_seq.sroa.0.0.i.i.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%dst.sroa.0.0.copyload.i29.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <<span class="z-constant z-llvm">16</span> x <span class="z-type z-llvm">i8</span>><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_5.i.i.i3.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!502</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%4</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <<span class="z-constant z-llvm">16</span> x <span class="z-type z-llvm">i8</span>> <span class="z-local z-llvm">%dst.sroa.0.0.copyload.i29.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%.sroa.0.15.vec.insert.i.i.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%5</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">bitcast</span> <<span class="z-constant z-llvm">16</span> x <span class="z-type z-llvm">i1</span>> <span class="z-local z-llvm">%4</span> <span class="z-keyword z-instruction z-misc z-llvm">to</span> <span class="z-type z-llvm">i16</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb2.i.i.i.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb2<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i:                                      <span class="z-comment z-llvm">; preds = %bb5.i.i.i.i, %bb1.i.i.i.i
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%iter.i.sroa.0.0.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">i16</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%5</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb1.i.i.i.i</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_13.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb5.i.i.i.i</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%6</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i16</span> <span class="z-local z-llvm">%iter.i.sroa.0.0.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%6</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb6.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb5.i.i.i.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb6<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i:                                      <span class="z-comment z-llvm">; preds = %bb2.i.i.i.i
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%7</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <<span class="z-constant z-llvm">16</span> x <span class="z-type z-llvm">i8</span>> <span class="z-local z-llvm">%dst.sroa.0.0.copyload.i29.i.i.i</span><span class="z-punctuation z-llvm">,</span> <<span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i8</span> -<span class="z-constant z-llvm">1</span>>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%8</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">bitcast</span> <<span class="z-constant z-llvm">16</span> x <span class="z-type z-llvm">i1</span>> <span class="z-local z-llvm">%7</span> <span class="z-keyword z-instruction z-misc z-llvm">to</span> <span class="z-type z-llvm">i16</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%9</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i16</span> <span class="z-local z-llvm">%8</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%9</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb11.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb11</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb5<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i:                                      <span class="z-comment z-llvm">; preds = %bb2.i.i.i.i
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%10</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">i16</span> <span class="z-punctuation z-llvm">@</span><span class="z-intrinsic z-llvm">llvm.cttz.i16</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">i16</span> <span class="z-local z-llvm">%iter.i.sroa.0.0.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i1</span> <span class="z-constant z-llvm">true</span><span class="z-punctuation z-llvm">)</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!range</span> <span class="z-tags z-llvm">!63</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_9.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">zext</span> <span class="z-keyword z-metadata z-llvm">nneg</span> <span class="z-type z-llvm">i16</span> <span class="z-local z-llvm">%10</span> <span class="z-keyword z-instruction z-misc z-llvm">to</span> <span class="z-type z-llvm">i64</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_14.i2.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">add</span> <span class="z-type z-llvm">i16</span> <span class="z-local z-llvm">%iter.i.sroa.0.0.i.i.i</span><span class="z-punctuation z-llvm">,</span> -<span class="z-constant z-llvm">1</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_13.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">and</span> <span class="z-type z-llvm">i16</span> <span class="z-local z-llvm">%_14.i2.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%iter.i.sroa.0.0.i.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_14.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">add</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%probe_seq.sroa.0.0.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%_9.i.i.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%index.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">and</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_14.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%self.val1.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_11.i.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">sub</span> <span class="z-keyword z-metadata z-llvm">nsw</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">0</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%index.i.i.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%gep.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-punctuation z-llvm">{</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span><span class="z-constant z-llvm">7</span> x <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"unit::Unit"</span> <span class="z-punctuation z-llvm">}</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%invariant.gep.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_11.i.i.i.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%.val.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%gep.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!range</span> <span class="z-tags z-llvm">!64</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noalias</span> <span class="z-tags z-llvm">!510</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_0.i.i.i.i.i.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i8</span> <span class="z-local z-llvm">%.val.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%_6.val</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%_0.i.i.i.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb12</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb2.i.i.i.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb11<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i<span class="z-punctuation z-llvm">.</span>i:                                     <span class="z-comment z-llvm">; preds = %bb6.i.i.i.i
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%11</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">add</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%probe_seq1.sroa.0.0.i.i.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">16</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%12</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-binary z-llvm">add</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%11</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%probe_seq.sroa.0.0.i.i.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb1.i.i.i.i</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb11:                                             <span class="z-comment z-llvm">; preds = %bb6.i.i.i.i, %start
</span></span><span class="z-source z-llvm"><span class="z-comment z-llvm">; call core::option::expect_failed
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-punctuation z-llvm">@</span><span class="z-function z-name z-llvm">core::option::expect_failed</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">readonly</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">1</span> <span class="z-punctuation z-llvm">@</span>alloc_a7d7769291fb702cd4ca6ef64f027ff9<span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-constant z-llvm">22</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">readonly</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">24</span><span class="z-punctuation z-llvm">)</span> <span class="z-punctuation z-llvm">@</span>alloc_b3f0fcdaf69e41a74e6f9070f90e708e<span class="z-punctuation z-llvm">)</span> #<span class="z-constant z-llvm">28</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">unreachable</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb12:                                             <span class="z-comment z-llvm">; preds = %bb5.i.i.i.i
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%13</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-punctuation z-llvm">{</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span><span class="z-constant z-llvm">7</span> x <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"unit::Unit"</span> <span class="z-punctuation z-llvm">}</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%self.val.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%_11.i.i.i.i.i</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%14</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-punctuation z-llvm">{</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span><span class="z-constant z-llvm">7</span> x <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> %<span class="z-string z-llvm">"unit::Unit"</span> <span class="z-punctuation z-llvm">}</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%13</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> -<span class="z-constant z-llvm">1</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i32</span> <span class="z-constant z-llvm">2</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i32</span> <span class="z-constant z-llvm">5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%speed</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i32</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%14</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">4</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%15</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%state</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">64</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-misc z-llvm">store</span> <span class="z-type z-llvm">i32</span> <span class="z-local z-llvm">%speed</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%15</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%16</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%state</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">8</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%state.val</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">ptr</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%16</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!nonnull</span> <span class="z-tags z-llvm">!5</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%17</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%state</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">16</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%state.val1</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i64</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%17</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_17.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> %<span class="z-string z-llvm">"effect::Effect"</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%state.val</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%state.val1</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%18</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i64</span> <span class="z-local z-llvm">%state.val1</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%18</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb6</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb5</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb6:                                              <span class="z-comment z-llvm">; preds = %bb2.backedge, %bb12
</span></span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">ret</span> <span class="z-type z-llvm">void</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb5:                                              <span class="z-comment z-llvm">; preds = %bb12, %bb2.backedge
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%iter.sroa.0.010</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">phi</span> <span class="z-type z-llvm">ptr</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%_14.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb2.backedge</span> <span class="z-punctuation z-llvm">]</span><span class="z-punctuation z-llvm">,</span> <span class="z-punctuation z-llvm">[</span> <span class="z-local z-llvm">%state.val</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%bb12</span> <span class="z-punctuation z-llvm">]</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_14.i.i</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> %<span class="z-string z-llvm">"effect::Effect"</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%iter.sroa.0.010</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">1</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%19</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">i32</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%iter.sroa.0.010</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!range</span> <span class="z-tags z-llvm">!405</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%trunc.not.not</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">i32</span> <span class="z-local z-llvm">%19</span><span class="z-punctuation z-llvm">,</span> <span class="z-constant z-llvm">0</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%trunc.not.not</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb2.backedge</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb7</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb7:                                              <span class="z-comment z-llvm">; preds = %bb5
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%20</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">getelementptr</span> <span class="z-keyword z-metadata z-llvm">inbounds</span> <span class="z-type z-llvm">i8</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%iter.sroa.0.010</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">i64</span> <span class="z-constant z-llvm">8</span>
</span><span class="z-source z-llvm">  <span class="z-local z-llvm">%_17</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-misc z-llvm">load</span> <span class="z-type z-llvm">ptr</span><span class="z-punctuation z-llvm">,</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%20</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!nonnull</span> <span class="z-tags z-llvm">!5</span><span class="z-punctuation z-llvm">,</span> <span class="z-tags z-llvm">!noundef</span> <span class="z-tags z-llvm">!5</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-local z-llvm">%_17</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">88</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%state</span><span class="z-punctuation z-llvm">)</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb2.backedge</span>
</span><span class="z-source z-llvm">
</span><span class="z-source z-llvm">bb2<span class="z-punctuation z-llvm">.</span>backedge:                                     <span class="z-comment z-llvm">; preds = %bb7, %bb5
</span></span><span class="z-source z-llvm">  <span class="z-local z-llvm">%21</span> <span class="z-punctuation z-llvm">=</span> <span class="z-keyword z-instruction z-other z-llvm">icmp</span> <span class="z-keyword z-instruction z-other z-llvm">eq</span> <span class="z-type z-llvm">ptr</span> <span class="z-local z-llvm">%_14.i.i</span><span class="z-punctuation z-llvm">,</span> <span class="z-local z-llvm">%_17.i</span>
</span><span class="z-source z-llvm">  <span class="z-keyword z-instruction z-terminator z-llvm">br</span> <span class="z-type z-llvm">i1</span> <span class="z-local z-llvm">%21</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb6</span><span class="z-punctuation z-llvm">,</span> <span class="z-keyword z-llvm">label</span> <span class="z-local z-llvm">%bb5</span>
</span><span class="z-source z-llvm"><span class="z-punctuation z-llvm">}</span>
</span></code></pre></details><br><pre class="language-llvm z-code" data-lang=llvm><code class=language-llvm data-lang=llvm><span class="z-source z-llvm"><span class="z-keyword z-metadata z-llvm">tail</span> <span class="z-keyword z-instruction z-other z-llvm">call</span> <span class="z-type z-llvm">void</span> <span class="z-local z-llvm">%_17</span><span class="z-punctuation z-llvm">(</span><span class="z-type z-llvm">ptr</span> <span class="z-keyword z-metadata z-llvm">noalias</span> <span class="z-keyword z-metadata z-llvm">noundef</span> <span class="z-keyword z-metadata z-llvm">nonnull</span> <span class="z-keyword z-metadata z-llvm">align</span> <span class="z-constant z-llvm">8</span> <span class="z-keyword z-metadata z-llvm">dereferenceable</span><span class="z-punctuation z-llvm">(</span><span class="z-constant z-llvm">88</span><span class="z-punctuation z-llvm">)</span> <span class="z-local z-llvm">%state</span><span class="z-punctuation z-llvm">)</span>
</span></code></pre><p>Same deal for <code>effect.apply</code>. <code>state</code> is not accessed by any other pointer during the execution of <code>apply</code>, it doesn't overlap with the <code>effects</code> iterator (which is a pointer to a different allocation on the heap), and the <code>effects</code> footprint-bytes are not written to.<h2 id=speculation>Speculation<a aria-hidden=true class=anchor hidden href=#speculation>#</a></h2><p>If everything above is accurate and I'm not misunderstanding anything, I think my exact usage is <em>not</em> UB under any circumstance. Even assuming the most pessimistic view - that accessing <code>&mut foo.baz</code> still counts as "overlapping access" with every other part of <code>&mut foo</code> - it's clear that any access to <code>&mut army</code> from within <code>reset_speed</code> does not overlap with <code>&mut state</code> in any way. <code>&mut state</code> is allocated on the heap, completely disjoint from <code>&mut army</code>. I would have to interleave access via <code>&mut state</code> with accessing the same memory via <code>&mut army.units[i]</code> or resize the vec for there to be any real problems. To generalize, for any struct<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-keyword z-rust">struct</span> <span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">S</span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">a</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-identifier z-rust">T</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">b</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-identifier z-rust">T</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> or *mut T, if it does not point to self.a
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">s</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">S</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-range z-rust">...</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p><code>s.method(unsafe_mut(&s.b))</code> should <em>not</em> result in UB so long as you don't access <code>b</code> through <code>&mut s</code> inside the method. If <code>b</code> is a pointer to a vec, and the unsafe reference passed in is <code>unafe_mut(&mut s.b[i])</code>, accessing <code>b</code>, and even <code>b[x]</code> through <code>&mut s</code> within the method should be fine, but only so long as <code>b</code> never changes sizes (which may result in a reallocation) <strong>and</strong> <code>x != i</code>. This is at least partially supported via miri, which <em>only</em> errors out when I intentionally interleave access to a value between <code>&mut self</code> and the <code>unsafe_mut</code> reference.<p>I don't think it's as straight forward if <code>b</code> is just a regular, non-pointer value. We're technically violating an assumption - the pointers that we're passing in <em>do</em> overlap - but accesses are what matter, not pointers, so as long as we're careful not to actually modify overlapping bits it should be fine. It all depends on what kinds of things Rust is doing in it's MIR - how its extra invariants are expressed and how those are translated to LLVM-IR. Maybe it's 100% not UB and I'm overthinking it, who knows. I still don't feel like I entirely grasp the semantics behind <code>!alias.scope</code> and <code>!noalias</code>.<p>It's probably safe to say that if you call a function <code>s.method(unsafe_mut(&mut s.a))</code>, observing the pointed-to-value of <code>b</code> and even changing the pointer of <code>s.b</code> is fine, since accessing <code>s.b</code> is a "shrinking" GEP. That said, assigning to the whole struct (<code>*s = s2</code>) is very likely UB. There might be some exceptions to that if, for example, <code>s2.a == s.a</code> but uh... "does a write count as an aliasing access even if the bits written are the same as the bits that were already there?" is some next level semantics that I'm not even gonna touch.<p>Either way, it was fun looking into how LLVM works. There were a lot of cool realizations along the way - a lot more of Rust is "smoke and mirrors" meant to massage the LLVM-IR than I expected. If this trick isn't UB, it's probably pretty handy for prototyping. That's a pretty big "if" though.<p>I mentioned before that there's safe versions of my example functions, which I'll put in an expand-o down below. They use indexing rather than iterators so they don't hold long-term borrows. We also pass the <code>state</code> <em>handle</em> to <code>reset_speed</code> instead of <code>&mut state</code>. The ASM and LLVM_IR generated are more or less identical between the safe and unsafe versions, accounting for register shuffling and a bit of panic handling for the array indexing.<details><summary>Safe tick_effects</summary> <pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-path z-rust"><span class="z-variable z-annotation z-rust">inline</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">never</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> <span class="z-entity z-name z-function z-rust">tick_effects</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-local z-rust">_inner</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">|</span><span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-storage z-type z-source z-rust">Army</span><span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">handle</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">units</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">len</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-local z-rust">i</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-keyword z-control z-rust">while</span> <span class="z-variable z-local z-rust">i</span> <span class="z-keyword z-operator z-comparison z-rust"><</span> <span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">units</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">handle</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">effects</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">len</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-keyword z-control z-rust">match</span> <span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">units</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">handle</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">effects</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">i</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                    <span class="z-meta z-path z-rust">effect<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-storage z-type z-source z-rust">Effect</span><span class="z-punctuation z-accessor z-rust">::</span><span class="z-storage z-type z-enum z-rust">StatModTemp</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                        <span class="z-variable z-local z-rust">stat</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">Stat</span><span class="z-punctuation z-accessor z-rust">::</span><span class="z-storage z-type z-enum z-rust">Speed</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                        <span class="z-variable z-local z-rust">apply</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-underscore z-rust">_</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                        <span class="z-variable z-local z-rust">timestamp</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-operator z-fatarrow z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                        <span class="z-keyword z-control z-rust">if</span> <span class="z-variable z-local z-rust">timestamp</span> <span class="z-keyword z-operator z-comparison z-rust"><=</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">time</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                            <span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">units</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">handle</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">effects</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">swap_remove</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">i</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                            <span class="z-variable z-local z-rust">army</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">reset_speed</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">handle</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                            <span class="z-variable z-local z-rust">i</span> <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                    <span class="z-keyword z-operator z-underscore z-rust">_</span> <span class="z-keyword z-operator z-fatarrow z-rust">=></span> <span class="z-variable z-local z-rust">i</span> <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-function z-rust">_inner</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">red</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-function z-rust">_inner</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">blu</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre></details><details><summary>Safe reset_speed</summary> <pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> <span class="z-entity z-name z-function z-rust">reset_speed</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-symbol z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-variable z-parameter z-rust">handle</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-primitive z-rust">usize</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">unit</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">units</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">handle</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-keyword z-rust">let</span> <span class="z-variable z-local z-rust">speed</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-other z-self z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">base_units</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-variable z-local z-rust">unit</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">base</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">movement</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">speed</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-local z-rust">unit</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">max_speed</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-local z-rust">speed</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> <span class="z-variable z-local z-rust">i</span> <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-variable z-local z-rust">unit</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">effects</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-function z-rust">len</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">match</span> <span class="z-variable z-local z-rust">unit</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-variable z-local z-rust">effects</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-local z-rust">i</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">Effect</span><span class="z-punctuation z-accessor z-rust">::</span><span class="z-storage z-type z-enum z-rust">StatModTemp</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-variable z-local z-rust">stat</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">Stat</span><span class="z-punctuation z-accessor z-rust">::</span><span class="z-storage z-type z-enum z-rust">Speed</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-variable z-local z-rust">apply</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-variable z-local z-rust">timestamp</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-underscore z-rust">_</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-operator z-fatarrow z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-variable z-function z-rust">apply</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-local z-rust">unit</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-keyword z-operator z-underscore z-rust">_</span> <span class="z-keyword z-operator z-fatarrow z-rust">=></span> <span class="z-keyword z-control z-rust">continue</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre></details></div><footer class=post-footer><ul class=post-tags><li><a href=https://walnut356.github.io/tags/programming/>programming</a><li><a href=https://walnut356.github.io/tags/rust/>rust</a><li><a href=https://walnut356.github.io/tags/compilers/>compilers</a></ul><nav class=paginav><a class=prev href=https://walnut356.github.io/posts/simulating-starcraft-p2/> <span class=title>« Prev</span> <br> <span>Simulating Starcraft Part 2 - Data Wrangling</span> </a><a class=next href=https://walnut356.github.io/posts/language-documentation/> <span class=title>Next »</span> <br> <span>Why is language documentation still so terrible?</span> </a></nav></footer></article></main><footer class=footer><span>© 2025 <a href=https://walnut356.github.io>Walnut356</a></span><span> Powered by <a rel="noopener noreferrer" href=https://www.getzola.org/ target=_blank>Zola</a> & <a href=https://github.com/cydave/zola-theme-papermod rel=noopener target=_blank>PaperMod</a> </span></footer><a aria-label="go to top" title="Go to Top (Alt + G)" accesskey=g class=top-link href=#top id=top-link> <svg viewbox="0 0 12 6" fill=currentColor xmlns=http://www.w3.org/2000/svg><path d="M12 6H0l6-6z"/></svg> </a><script>let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });</script><script>var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };</script><script>document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })</script><script>document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';
        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                var content = codeblock.textContent;
                if(codeblock.firstChild.tagName == 'TABLE') {
                    content = Array(...codeblock.firstChild.getElementsByTagName('span')).map((span) => { return span.textContent; }).join('');
                }
                navigator.clipboard.writeText(content);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });</script>